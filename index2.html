<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Assistant</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0c0c0e;
    --surface: #16161a;
    --surface2: #1e1e24;
    --border: #28282f;
    --accent: #b8ff4f;
    --accent2: #5c7cff;
    --accent3: #ff7c5c;
    --text: #eeede8;
    --muted: #6e6e80;
    --red: #ff5c5c;
    --purple: #b07cff;
    --orange: #ffaa5c;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family:'DM Sans',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; display:flex; flex-direction:column; overflow:hidden; }

  /* HEADER */
  header { display:flex; align-items:center; justify-content:space-between; padding:0 24px; height:56px; border-bottom:1px solid var(--border); background:var(--bg); position:relative; z-index:100; flex-shrink:0; }
  .logo { font-family:'DM Serif Display',serif; font-size:1.3rem; }
  .logo em { color:var(--accent); font-style:normal; }
  .header-center { display:flex; align-items:center; gap:8px; }
  .date-nav-btn { background:none; border:1px solid var(--border); color:var(--muted); width:26px; height:26px; border-radius:6px; cursor:pointer; font-size:.9rem; display:flex; align-items:center; justify-content:center; transition:all .15s; }
  .date-nav-btn:hover { color:var(--text); border-color:var(--muted); }
  .date-pill { font-size:.76rem; font-weight:600; background:var(--surface); border:1px solid var(--border); padding:5px 14px; border-radius:20px; min-width:180px; text-align:center; cursor:pointer; }
  .date-pill:hover { border-color:var(--muted); }
  .header-right { display:flex; align-items:center; gap:7px; }
  .gcal-btn { display:flex; align-items:center; gap:6px; font-family:'DM Sans',sans-serif; font-size:.75rem; font-weight:600; padding:6px 12px; border-radius:7px; border:1px solid var(--border); background:var(--surface); color:var(--muted); cursor:pointer; transition:all .2s; }
  .gcal-btn:hover { border-color:var(--muted); color:var(--text); }
  .gcal-btn.connected { border-color:var(--accent); color:var(--accent); background:rgba(184,255,79,.06); }
  .gcal-btn .dot { width:6px; height:6px; border-radius:50%; background:var(--muted); }
  .gcal-btn.connected .dot { background:var(--accent); }
  .btn { font-family:'DM Sans',sans-serif; font-size:.76rem; font-weight:600; padding:6px 14px; border-radius:7px; border:none; cursor:pointer; transition:all .15s; display:flex; align-items:center; gap:5px; }
  .btn-primary { background:var(--accent); color:#0c0c0e; }
  .btn-primary:hover { filter:brightness(1.1); transform:translateY(-1px); }
  .btn-ghost { background:transparent; color:var(--muted); border:1px solid var(--border); }
  .btn-ghost:hover { color:var(--text); border-color:var(--muted); }

  /* BARS */
  .sync-bar { display:none; align-items:center; justify-content:center; gap:8px; padding:6px; background:rgba(92,124,255,.1); border-bottom:1px solid rgba(92,124,255,.2); font-size:.73rem; color:var(--accent2); font-weight:500; flex-shrink:0; }
  .sync-bar.visible { display:flex; }
  @keyframes spin { to { transform:rotate(360deg); } }
  .spin { display:inline-block; animation:spin .8s linear infinite; }
  .notif-banner { display:none; align-items:center; justify-content:space-between; padding:7px 20px; background:rgba(255,170,92,.08); border-bottom:1px solid rgba(255,170,92,.2); font-size:.73rem; color:var(--orange); flex-shrink:0; }
  .notif-banner.visible { display:flex; }
  .notif-banner button { font-family:'DM Sans',sans-serif; font-size:.7rem; font-weight:600; padding:4px 10px; border-radius:5px; background:var(--orange); color:#0c0c0e; border:none; cursor:pointer; }

  /* LAYOUT */
  .app-body { display:grid; grid-template-columns:230px 1fr 280px; flex:1; overflow:hidden; height:calc(100vh - 56px); }

  /* SIDEBAR */
  .sidebar { border-right:1px solid var(--border); display:flex; flex-direction:column; overflow:hidden; }
  .sidebar-scroll { overflow-y:auto; flex:1; padding:18px 14px; display:flex; flex-direction:column; gap:22px; }
  .s-label { font-size:.63rem; font-weight:600; letter-spacing:.1em; color:var(--muted); text-transform:uppercase; margin-bottom:9px; }

  /* Mini Calendar */
  .cal-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:9px; }
  .cal-header span { font-size:.8rem; font-weight:600; }
  .cal-arrow { background:none; border:none; color:var(--muted); cursor:pointer; font-size:1rem; padding:2px 5px; border-radius:4px; transition:color .15s; }
  .cal-arrow:hover { color:var(--text); }
  .cal-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:2px; text-align:center; }
  .cdn { font-size:.58rem; color:var(--muted); padding:3px 0; font-weight:600; }
  .cd { font-size:.7rem; padding:4px 2px; border-radius:5px; cursor:pointer; color:var(--muted); transition:all .15s; }
  .cd:hover { background:var(--surface2); color:var(--text); }
  .cd.today { background:var(--accent); color:#0c0c0e; font-weight:700; }
  .cd.selected { background:var(--surface2); color:var(--text); outline:1px solid var(--accent2); }
  .cd.has-event { color:var(--text); }
  .cd.has-event::after { content:'¬∑'; display:block; color:var(--accent2); margin-top:-6px; font-size:1.2rem; }

  /* Progress */
  .prog-wrap { display:flex; flex-direction:column; gap:6px; }
  .prog-row { display:flex; justify-content:space-between; font-size:.76rem; }
  .prog-label { color:var(--muted); }
  .prog-val { font-weight:600; }
  .prog-val.g { color:var(--accent); }
  .prog-val.b { color:var(--accent2); }
  .prog-bar { height:3px; background:var(--surface2); border-radius:3px; overflow:hidden; margin-top:2px; }
  .prog-fill { height:100%; background:var(--accent); border-radius:3px; transition:width .6s ease; }

  /* Upcoming */
  .upcoming-list { display:flex; flex-direction:column; gap:5px; }
  .upc-item { display:flex; gap:7px; align-items:flex-start; padding:7px 9px; background:var(--surface); border:1px solid var(--border); border-radius:7px; font-size:.73rem; cursor:pointer; transition:border-color .15s; }
  .upc-item:hover { border-color:var(--muted); }
  .upc-dot { width:6px; height:6px; border-radius:50%; flex-shrink:0; margin-top:3px; }
  .upc-text { color:var(--text); line-height:1.35; }
  .upc-date { color:var(--muted); font-size:.65rem; margin-top:2px; }

  /* Reminder list */
  .rem-item { display:flex; align-items:center; gap:7px; padding:7px 9px; background:var(--surface); border:1px solid var(--border); border-radius:7px; font-size:.73rem; }
  .rem-text { flex:1; color:var(--text); }
  .rem-time { color:var(--muted); font-size:.65rem; white-space:nowrap; }
  .rem-del { background:none; border:none; color:var(--muted); cursor:pointer; font-size:.7rem; padding:2px 4px; border-radius:3px; }
  .rem-del:hover { color:var(--red); }

  /* MAIN */
  .main { display:flex; flex-direction:column; overflow:hidden; }
  .main-top { padding:18px 24px 12px; border-bottom:1px solid var(--border); flex-shrink:0; }
  .main-title { font-family:'DM Serif Display',serif; font-size:1.8rem; line-height:1; }
  .main-sub { color:var(--muted); font-size:.77rem; margin-top:4px; display:flex; align-items:center; gap:10px; }
  .main-sub strong { color:var(--accent); }
  .schedule-wrap { flex:1; overflow-y:auto; padding:8px 24px 24px; }
  .sched-rel { position:relative; }

  /* Schedule */
  .time-slot { display:grid; grid-template-columns:50px 1fr; min-height:58px; }
  .t-label { font-size:.65rem; color:var(--muted); padding-top:8px; text-align:right; padding-right:12px; font-weight:500; }
  .t-body { border-left:1px solid var(--border); padding:5px 0 5px 12px; position:relative; min-height:58px; transition:background .15s; }
  .t-body::before { content:''; position:absolute; left:-4px; top:10px; width:6px; height:6px; border-radius:50%; border:1px solid var(--border); background:var(--bg); }
  .t-body.drag-over { background:rgba(92,124,255,.07); }
  .t-body.drag-over::before { background:var(--accent2); border-color:var(--accent2); }

  /* Task card */
  .tc { display:flex; align-items:flex-start; gap:8px; padding:8px 11px; background:var(--surface); border:1px solid var(--border); border-radius:8px; margin-bottom:5px; cursor:grab; transition:all .15s; user-select:none; position:relative; overflow:hidden; animation:slideIn .2s ease; }
  @keyframes slideIn { from { opacity:0; transform:translateX(-6px); } to { opacity:1; transform:translateX(0); } }
  .tc::before { content:''; position:absolute; left:0; top:0; bottom:0; width:3px; border-radius:3px 0 0 3px; }
  .tc:hover { border-color:var(--muted); transform:translateX(2px); }
  .tc.dragging { opacity:.3; }
  .tc.done { opacity:.4; }
  .tc.done .tc-title { text-decoration:line-through; color:var(--muted); }
  .c-work::before { background:var(--accent2); }
  .c-personal::before { background:var(--accent); }
  .c-health::before { background:var(--orange); }
  .c-home::before { background:var(--purple); }
  .c-gcal::before { background:var(--accent3); }
  .tc-grip { color:var(--muted); font-size:.8rem; cursor:grab; margin-top:2px; opacity:0; transition:opacity .15s; }
  .tc:hover .tc-grip { opacity:1; }
  .tc-check { width:16px; height:16px; border-radius:50%; border:2px solid var(--border); flex-shrink:0; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all .15s; margin-top:2px; }
  .tc-check:hover { border-color:var(--accent); }
  .tc-check.chk { background:var(--accent); border-color:var(--accent); }
  .tc-check.chk::after { content:'‚úì'; font-size:.58rem; color:#0c0c0e; font-weight:800; }
  .tc-info { flex:1; min-width:0; }
  .tc-title { font-size:.81rem; font-weight:500; line-height:1.3; }
  .tc-meta { display:flex; gap:4px; margin-top:3px; flex-wrap:wrap; align-items:center; }
  .tc-tag { font-size:.6rem; padding:2px 6px; border-radius:20px; background:var(--surface2); color:var(--muted); font-weight:500; }
  .tc-tag.gcal-tag { background:rgba(255,124,92,.12); color:var(--accent3); }
  .tc-dur { font-size:.6rem; color:var(--muted); }
  .tc-recur { font-size:.6rem; color:var(--accent2); }
  .tc-actions { display:flex; gap:2px; opacity:0; transition:opacity .15s; }
  .tc:hover .tc-actions { opacity:1; }
  .tc-btn { background:none; border:none; color:var(--muted); font-size:.68rem; cursor:pointer; padding:3px 5px; border-radius:4px; transition:all .15s; }
  .tc-btn:hover { color:var(--red); background:rgba(255,92,92,.1); }
  .tc-btn.push-btn:hover { color:var(--accent3); background:rgba(255,124,92,.1); }
  .empty-slot { height:34px; border:1px dashed var(--border); border-radius:6px; display:flex; align-items:center; justify-content:center; color:var(--muted); font-size:.68rem; cursor:pointer; transition:all .15s; margin-bottom:4px; }
  .empty-slot:hover { border-color:var(--accent2); color:var(--accent2); background:rgba(92,124,255,.04); }
  .now-line { position:absolute; left:50px; right:0; height:2px; background:var(--red); z-index:10; pointer-events:none; }
  .now-line::before { content:''; position:absolute; left:12px; top:-4px; width:8px; height:8px; border-radius:50%; background:var(--red); }
  .now-label { position:absolute; right:8px; top:-9px; font-size:.58rem; color:var(--red); font-weight:700; background:var(--bg); padding:0 3px; }

  /* RIGHT PANEL */
  .rpanel { border-left:1px solid var(--border); display:flex; flex-direction:column; overflow:hidden; }
  .rtabs { display:flex; border-bottom:1px solid var(--border); flex-shrink:0; }
  .rtab { flex:1; padding:11px 4px; font-size:.68rem; font-weight:600; text-align:center; cursor:pointer; color:var(--muted); border:none; background:none; font-family:'DM Sans',sans-serif; border-bottom:2px solid transparent; transition:all .15s; }
  .rtab.active { color:var(--text); border-bottom-color:var(--accent); }
  .rpanel-body { flex:1; overflow-y:auto; padding:16px 14px; }

  /* AI CHAT */
  .chat-wrap { display:flex; flex-direction:column; height:100%; }
  .chat-messages { flex:1; overflow-y:auto; display:flex; flex-direction:column; gap:10px; padding-bottom:8px; min-height:200px; max-height:360px; }
  .chat-msg { display:flex; gap:8px; align-items:flex-start; animation:slideIn .2s ease; }
  .chat-msg.user { flex-direction:row-reverse; }
  .chat-avatar { width:26px; height:26px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:.75rem; flex-shrink:0; }
  .chat-avatar.ai { background:var(--accent); color:#0c0c0e; font-weight:700; }
  .chat-avatar.user { background:var(--accent2); color:#fff; font-weight:700; }
  .chat-bubble { max-width:85%; padding:8px 11px; border-radius:10px; font-size:.78rem; line-height:1.45; }
  .chat-msg.ai .chat-bubble { background:var(--surface); border:1px solid var(--border); color:var(--text); border-radius:3px 10px 10px 10px; }
  .chat-msg.user .chat-bubble { background:var(--accent2); color:#fff; border-radius:10px 3px 10px 10px; }
  .chat-bubble.thinking { color:var(--muted); font-style:italic; }
  .chat-input-wrap { display:flex; gap:7px; margin-top:10px; border-top:1px solid var(--border); padding-top:10px; }
  .chat-input { flex:1; background:var(--surface); border:1px solid var(--border); border-radius:8px; color:var(--text); font-family:'DM Sans',sans-serif; font-size:.78rem; padding:8px 11px; outline:none; resize:none; height:38px; transition:border-color .15s; }
  .chat-input:focus { border-color:var(--accent2); }
  .chat-send { background:var(--accent); color:#0c0c0e; border:none; border-radius:8px; width:36px; height:38px; cursor:pointer; font-size:1rem; display:flex; align-items:center; justify-content:center; transition:all .15s; flex-shrink:0; }
  .chat-send:hover { filter:brightness(1.1); }
  .chat-suggestions { display:flex; flex-wrap:wrap; gap:5px; margin-bottom:10px; }
  .chat-sug { font-size:.65rem; padding:4px 9px; border-radius:20px; border:1px solid var(--border); background:var(--surface); color:var(--muted); cursor:pointer; transition:all .15s; font-family:'DM Sans',sans-serif; }
  .chat-sug:hover { border-color:var(--accent2); color:var(--accent2); }

  /* FORM */
  .form-group { margin-bottom:11px; }
  .form-group label { display:block; font-size:.64rem; font-weight:600; color:var(--muted); text-transform:uppercase; letter-spacing:.07em; margin-bottom:4px; }
  input[type=text],input[type=number],input[type=date],input[type=time],select,textarea { width:100%; background:var(--surface); border:1px solid var(--border); border-radius:7px; color:var(--text); font-family:'DM Sans',sans-serif; font-size:.78rem; padding:7px 10px; outline:none; transition:border-color .15s; -webkit-appearance:none; }
  input:focus,select:focus,textarea:focus { border-color:var(--accent2); }
  select option { background:var(--surface2); }
  textarea { resize:none; height:48px; }
  .pills { display:flex; gap:5px; flex-wrap:wrap; }
  .pill { font-size:.68rem; padding:4px 9px; border-radius:20px; border:1px solid var(--border); cursor:pointer; transition:all .15s; background:transparent; color:var(--muted); font-family:'DM Sans',sans-serif; font-weight:500; }
  .pill.active-work { background:var(--accent2); color:#fff; border-color:var(--accent2); }
  .pill.active-personal { background:var(--accent); color:#0c0c0e; border-color:var(--accent); }
  .pill.active-health { background:var(--orange); color:#0c0c0e; border-color:var(--orange); }
  .pill.active-home { background:var(--purple); color:#fff; border-color:var(--purple); }
  .recur-pills { display:flex; gap:5px; flex-wrap:wrap; }
  .rpill { font-size:.68rem; padding:4px 9px; border-radius:20px; border:1px solid var(--border); cursor:pointer; background:transparent; color:var(--muted); font-family:'DM Sans',sans-serif; transition:all .15s; }
  .rpill.active { background:var(--surface2); color:var(--text); border-color:var(--accent2); }

  /* Motivation */
  .mot-card { background:linear-gradient(135deg,#141420 0%,#0e1a2e 100%); border:1px solid var(--border); border-radius:9px; padding:14px; margin-bottom:14px; }
  .mot-label { font-size:.6rem; color:var(--accent2); font-weight:600; letter-spacing:.08em; text-transform:uppercase; margin-bottom:6px; }
  .mot-quote { font-family:'DM Serif Display',serif; font-size:.92rem; line-height:1.45; color:var(--text); font-style:italic; }

  /* Sync status */
  .sheets-status { display:flex; align-items:center; gap:7px; font-size:.73rem; padding:8px 11px; background:var(--surface); border:1px solid var(--border); border-radius:7px; margin-bottom:12px; }
  .sheets-dot { width:7px; height:7px; border-radius:50%; background:var(--muted); }
  .sheets-dot.synced { background:var(--accent); }
  .sheets-dot.syncing { background:var(--orange); animation:pulse 1s infinite; }
  @keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:.4;} }

  /* Toast */
  .toast { position:fixed; bottom:18px; left:50%; transform:translateX(-50%) translateY(80px); background:var(--surface2); border:1px solid var(--border); color:var(--text); padding:9px 16px; border-radius:8px; font-size:.78rem; font-weight:500; z-index:9999; transition:transform .3s ease; box-shadow:0 8px 32px rgba(0,0,0,.6); white-space:nowrap; }
  .toast.show { transform:translateX(-50%) translateY(0); }

  ::-webkit-scrollbar { width:3px; }
  ::-webkit-scrollbar-track { background:transparent; }
  ::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }
</style>
</head>
<body>

<header>
  <div class="logo">my<em>.</em>assistant</div>
  <div class="header-center">
    <button class="date-nav-btn" onclick="shiftDay(-1)">‚Äπ</button>
    <div class="date-pill" id="datePill" onclick="goToday()"></div>
    <button class="date-nav-btn" onclick="shiftDay(1)">‚Ä∫</button>
  </div>
  <div class="header-right">
    <div class="sheets-status" id="sheetsStatus" style="padding:5px 10px;">
      <div class="sheets-dot" id="sheetsDot"></div>
      <span id="sheetsLabel" style="font-size:.7rem;color:var(--muted)">Connecting...</span>
    </div>
    <button class="gcal-btn" id="gcalBtn" onclick="toggleGcal()">
      <span class="dot"></span>
      <span id="gcalBtnLabel">Connect Google Cal</span>
    </button>
    <button class="btn btn-primary" onclick="openTab('chat')">üí¨ Ask AI</button>
    <button class="btn btn-ghost" onclick="openTab('add')">+ Add</button>
  </div>
</header>

<div class="notif-banner" id="notifBanner">
  üîî Enable notifications to get reminders in the background
  <button onclick="requestNotif()">Enable</button>
</div>
<div class="sync-bar" id="syncBar">
  <span class="spin">‚ü≥</span> <span id="syncMsg">Syncing...</span>
</div>

<div class="app-body">

  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sidebar-scroll">
      <div>
        <div class="cal-header">
          <button class="cal-arrow" onclick="calShift(-1)">‚Äπ</button>
          <span id="calTitle"></span>
          <button class="cal-arrow" onclick="calShift(1)">‚Ä∫</button>
        </div>
        <div class="cal-grid" id="calGrid"></div>
      </div>
      <div>
        <div class="s-label">Today's Progress</div>
        <div class="prog-wrap">
          <div class="prog-row"><span class="prog-label">Done</span><span class="prog-val g" id="sDone">0</span></div>
          <div class="prog-row"><span class="prog-label">Left</span><span class="prog-val b" id="sLeft">0</span></div>
          <div class="prog-row"><span class="prog-label">Total</span><span class="prog-val" id="sTotal">0</span></div>
          <div class="prog-bar"><div class="prog-fill" id="progFill" style="width:0%"></div></div>
        </div>
      </div>
      <div>
        <div class="s-label">Next 7 Days</div>
        <div class="upcoming-list" id="upcomingList"></div>
      </div>
      <div>
        <div class="s-label">Active Reminders</div>
        <div id="reminderList"></div>
      </div>
    </div>
  </div>

  <!-- MAIN -->
  <div class="main">
    <div class="main-top">
      <div class="main-title" id="mainTitle"></div>
      <div class="main-sub">
        <span><strong id="mcDone">0</strong> / <span id="mcTotal">0</span> tasks done</span>
        <span id="gcalStatus" style="font-size:.73rem;"></span>
      </div>
    </div>
    <div class="schedule-wrap">
      <div class="sched-rel" id="schedRel">
        <div id="schedule"></div>
      </div>
    </div>
  </div>

  <!-- RIGHT PANEL -->
  <div class="rpanel">
    <div class="rtabs">
      <button class="rtab active" id="rtab-chat" onclick="openTab('chat')">ü§ñ AI Chat</button>
      <button class="rtab" id="rtab-overview" onclick="openTab('overview')">Today</button>
      <button class="rtab" id="rtab-add" onclick="openTab('add')">Add</button>
      <button class="rtab" id="rtab-remind" onclick="openTab('remind')">Reminders</button>
    </div>
    <div class="rpanel-body" id="rpanelBody"></div>
  </div>

</div>

<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CLIENT_ID = '432572693539-6r5i8oak1gnhqvimqccfj37hmng7pl43.apps.googleusercontent.com';
const SCOPES = 'https://www.googleapis.com/auth/calendar';
const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';
const GEMINI_KEY = 'AIzaSyBVQ8eECiRC4O62GixkcysC12YxFkIzslk';
const SHEETS_URL = 'https://script.google.com/macros/s/AKfycbwXpdmPm9iKZiOYWxYqdhvj2458m4iwO28odaaCnxwACyFtlfFrSqhmPi2XP07OpmTn_g/exec';
const GEMINI_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_KEY}`;

const HOURS = [6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22];
const HL = {6:'6 AM',7:'7 AM',8:'8 AM',9:'9 AM',10:'10 AM',11:'11 AM',12:'12 PM',13:'1 PM',14:'2 PM',15:'3 PM',16:'4 PM',17:'5 PM',18:'6 PM',19:'7 PM',20:'8 PM',21:'9 PM',22:'10 PM'};
const CAT_COLORS = {work:'var(--accent2)',personal:'var(--accent)',health:'var(--orange)',home:'var(--purple)',gcal:'var(--accent3)'};
const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];
const DAYS = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
const QUOTES = ["The secret of getting ahead is getting started.","Small steps every day lead to big results.","Focus on progress, not perfection.","Your future self will thank you.","One day at a time ‚Äî that's enough.","What you do today can improve all your tomorrows."];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let tasks = [];
let reminders = [];
let gcalEvents = [];
let chatHistory = [];
let viewDate = new Date();
let calDate = new Date();
let dragId = null;
let selCat = 'work';
let selRecur = null;
let activeTab = 'chat';
let gapiReady = false;
let gsiTokenClient = null;
let isSignedIn = false;
let reminderTimers = [];
let sheetsReady = false;
let lastSheetsSave = 0;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GOOGLE SHEETS SYNC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function sheetsRead(sheet) {
  try {
    const url = `${SHEETS_URL}?action=read&sheet=${sheet}&t=${Date.now()}`;
    const r = await fetch(url);
    const d = await r.json();
    return d.data || [];
  } catch(e) { return []; }
}

async function sheetsWrite(sheet, rows) {
  try {
    const params = new URLSearchParams({ action:'write', sheet, rows:JSON.stringify(rows) });
    await fetch(`${SHEETS_URL}?${params}`);
  } catch(e) {}
}

function tasksToRows(tasks) {
  const header = ['id','title','hour','cat','dur','done','recur','date','notes','gcalId'];
  const rows = [header, ...tasks.map(t => header.map(k => t[k]===null||t[k]===undefined?'':String(t[k])))];
  return rows;
}

function rowsToTasks(rows) {
  if (!rows.length) return [];
  const header = rows[0];
  return rows.slice(1).filter(r=>r[0]).map(r => {
    const obj = {};
    header.forEach((h,i) => obj[h] = r[i]);
    return {
      id: parseInt(obj.id)||0,
      title: obj.title||'',
      hour: parseInt(obj.hour)||9,
      cat: obj.cat||'work',
      dur: parseInt(obj.dur)||30,
      done: obj.done==='true',
      recur: obj.recur||null,
      date: obj.date||'',
      notes: obj.notes||'',
      gcalId: obj.gcalId||null
    };
  });
}

function remindersToRows(rems) {
  const header = ['id','text','datetime'];
  return [header, ...rems.map(r => [r.id, r.text, r.datetime])];
}

function rowsToReminders(rows) {
  if (!rows.length) return [];
  const header = rows[0];
  return rows.slice(1).filter(r=>r[0]).map(r => ({
    id: parseInt(r[0])||Date.now(),
    text: r[1]||'',
    datetime: r[2]||''
  }));
}

async function loadFromSheets() {
  setSheetsStatus('syncing', 'Syncing data...');
  try {
    const [taskRows, remRows] = await Promise.all([
      sheetsRead('tasks'),
      sheetsRead('reminders')
    ]);
    if (taskRows.length > 1) {
      tasks = rowsToTasks(taskRows);
    } else if (!tasks.length) {
      seedTasks();
    }
    if (remRows.length > 1) {
      reminders = rowsToReminders(remRows);
    }
    sheetsReady = true;
    setSheetsStatus('synced', 'Synced');
    renderAll();
    scheduleAllReminders();
  } catch(e) {
    setSheetsStatus('error', 'Sync error');
    // Fall back to localStorage
    tasks = JSON.parse(localStorage.getItem('mya_tasks')||'[]');
    reminders = JSON.parse(localStorage.getItem('mya_reminders')||'[]');
    if (!tasks.length) seedTasks();
    renderAll();
  }
}

async function saveToSheets() {
  const now = Date.now();
  if (now - lastSheetsSave < 2000) return; // debounce
  lastSheetsSave = now;
  // Also save to localStorage as backup
  localStorage.setItem('mya_tasks', JSON.stringify(tasks));
  localStorage.setItem('mya_reminders', JSON.stringify(reminders));
  if (!sheetsReady) return;
  setSheetsStatus('syncing', 'Saving...');
  try {
    await Promise.all([
      sheetsWrite('tasks', tasksToRows(tasks)),
      sheetsWrite('reminders', remindersToRows(reminders))
    ]);
    setSheetsStatus('synced', 'Saved ‚úì');
    setTimeout(()=>setSheetsStatus('synced','Synced'),2000);
  } catch(e) {
    setSheetsStatus('error','Save failed');
  }
}

function setSheetsStatus(state, label) {
  const dot = document.getElementById('sheetsDot');
  const lbl = document.getElementById('sheetsLabel');
  if (!dot||!lbl) return;
  dot.className = 'sheets-dot' + (state==='synced'?' synced':state==='syncing'?' syncing':'');
  lbl.textContent = label;
  lbl.style.color = state==='synced'?'var(--accent)':state==='syncing'?'var(--orange)':'var(--red)';
}

function seedTasks() {
  const ds = d => { const x=new Date(); x.setDate(x.getDate()+d); return x.toISOString().split('T')[0]; };
  tasks = [
    {id:1,title:'Morning workout',hour:7,cat:'health',dur:45,done:false,recur:null,date:ds(0),notes:'',gcalId:null},
    {id:2,title:'Review weekly goals',hour:9,cat:'work',dur:30,done:false,recur:null,date:ds(0),notes:'',gcalId:null},
    {id:3,title:'Team standup',hour:10,cat:'work',dur:30,done:false,recur:'daily',date:ds(0),notes:'',gcalId:null},
    {id:4,title:'Lunch break',hour:13,cat:'personal',dur:60,done:false,recur:null,date:ds(0),notes:'',gcalId:null},
    {id:5,title:'Clean bedroom',hour:15,cat:'home',dur:30,done:false,recur:'biweekly',date:ds(0),notes:'Every 2 weeks',gcalId:null},
    {id:6,title:'Evening walk',hour:19,cat:'health',dur:30,done:false,recur:'daily',date:ds(0),notes:'',gcalId:null},
  ];
}

function nextId() { return tasks.length ? Math.max(...tasks.map(t=>t.id))+1 : 1; }
function todayStr() { return viewDate.toISOString().split('T')[0]; }
function realToday() { return new Date().toISOString().split('T')[0]; }
function dayTasks() { return tasks.filter(t=>t.date===todayStr()); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GEMINI AI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function askGemini(userMsg) {
  const todayTasks = dayTasks();
  const upcomingTasks = tasks.filter(t=>{
    const d=new Date(t.date+'T12:00:00');
    const diff=(d-new Date())/86400000;
    return diff>0&&diff<=7;
  });

  const systemContext = `You are a personal assistant AI embedded in a daily planner app. Today is ${new Date().toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'})}.

The user's tasks today: ${JSON.stringify(todayTasks.map(t=>({title:t.title,hour:HL[t.hour],cat:t.cat,done:t.done,recur:t.recur})))}
Upcoming tasks (next 7 days): ${JSON.stringify(upcomingTasks.map(t=>({title:t.title,date:t.date,hour:HL[t.hour],cat:t.cat})))}
Active reminders: ${JSON.stringify(reminders.map(r=>({text:r.text,datetime:r.datetime})))}

You can help the user by:
1. Answering questions about their schedule
2. Creating tasks ‚Äî respond with JSON action when the user wants to add a task
3. Setting reminders ‚Äî respond with JSON action when the user wants a reminder
4. Giving advice about their day

When creating a task or reminder, ALWAYS respond with this exact JSON format at the END of your message:
For tasks: <<<ACTION:{"type":"add_task","title":"...","hour":9,"cat":"work","dur":30,"recur":null,"date":"YYYY-MM-DD","notes":""}>>>
For reminders: <<<ACTION:{"type":"add_reminder","text":"...","datetime":"YYYY-MM-DDTHH:MM:00"}>>>
For deleting: <<<ACTION:{"type":"delete_task","title":"..."}>>>

Categories must be one of: work, personal, health, home
Recur must be one of: null, daily, weekly, biweekly, monthly
Always use 24h hour integers (6-22) for hour field.
Keep your conversational response friendly and concise (2-3 sentences max before the action).`;

  const messages = [
    ...chatHistory.slice(-6).map(m=>({role:m.role,parts:[{text:m.content}]})),
    {role:'user', parts:[{text:userMsg}]}
  ];

  const body = {
    systemInstruction: {parts:[{text:systemContext}]},
    contents: messages,
    generationConfig: {temperature:0.7, maxOutputTokens:400}
  };

  const resp = await fetch(GEMINI_URL, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(body)
  });

  if (!resp.ok) throw new Error('Gemini API error: ' + resp.status);
  const data = await resp.json();
  return data.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, I couldn't understand that. Please try again.";
}

function parseAndExecuteAction(text) {
  const match = text.match(/<<<ACTION:(.*?)>>>/s);
  if (!match) return text;

  const cleanText = text.replace(/<<<ACTION:.*?>>>/s,'').trim();

  try {
    const action = JSON.parse(match[1]);

    if (action.type==='add_task') {
      const task = {
        id:nextId(), title:action.title, hour:action.hour||9,
        cat:action.cat||'work', dur:action.dur||30, done:false,
        recur:action.recur||null, date:action.date||realToday(),
        notes:action.notes||'', gcalId:null
      };
      tasks.push(task);

      if (action.recur) {
        const imap={daily:1,weekly:7,biweekly:14,monthly:30};
        const days=imap[action.recur];
        for(let i=1;i<=12;i++){
          const fd=new Date(action.date||realToday()); fd.setDate(fd.getDate()+days*i);
          tasks.push({...task,id:nextId()+i,done:false,gcalId:null,date:fd.toISOString().split('T')[0]});
        }
      }

      saveToSheets();
      renderAll();
      renderCalendar();
      return cleanText + `\n\n‚úÖ Added **"${action.title}"** to your schedule!`;
    }

    if (action.type==='add_reminder') {
      reminders.push({id:Date.now(), text:action.text, datetime:action.datetime});
      saveToSheets();
      scheduleAllReminders();
      renderSidebar();
      return cleanText + `\n\nüîî Reminder set for **"${action.text}"**!`;
    }

    if (action.type==='delete_task') {
      const before = tasks.length;
      tasks = tasks.filter(t=>!t.title.toLowerCase().includes(action.title.toLowerCase()));
      if (tasks.length < before) {
        saveToSheets();
        renderAll();
        return cleanText + `\n\nüóëÔ∏è Removed tasks matching **"${action.title}"**.`;
      }
      return cleanText + `\n\nI couldn't find a task matching "${action.title}".`;
    }
  } catch(e) {}

  return cleanText;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GOOGLE CALENDAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initGapi() {
  gapi.load('client', async () => {
    try {
      await gapi.client.init({discoveryDocs:[DISCOVERY_DOC]});
      gapiReady = true;
      const saved = localStorage.getItem('mya_gtoken');
      if (saved) {
        gapi.client.setToken(JSON.parse(saved));
        isSignedIn = true;
        updateGcalUI();
        syncFromGcal();
      }
    } catch(e) {}
  });

  gsiTokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID, scope: SCOPES,
    callback: (resp) => {
      if (resp.error) { toast('Google auth error'); return; }
      localStorage.setItem('mya_gtoken', JSON.stringify(gapi.client.getToken()));
      isSignedIn = true;
      updateGcalUI();
      syncFromGcal();
      toast('‚úì Connected to Google Calendar!');
    }
  });
}

function toggleGcal() {
  if (!gapiReady) { toast('Google API loading...'); return; }
  if (isSignedIn) {
    google.accounts.oauth2.revoke(gapi.client.getToken().access_token, ()=>{
      gapi.client.setToken(null);
      localStorage.removeItem('mya_gtoken');
      isSignedIn=false; gcalEvents=[];
      updateGcalUI(); renderAll();
      toast('Disconnected from Google Calendar');
    });
  } else {
    gsiTokenClient.requestAccessToken({prompt:'consent'});
  }
}

function updateGcalUI() {
  const btn=document.getElementById('gcalBtn');
  const lbl=document.getElementById('gcalBtnLabel');
  const stat=document.getElementById('gcalStatus');
  if (isSignedIn) {
    btn.classList.add('connected'); lbl.textContent='Google Cal ‚úì';
    stat.textContent='‚óè Synced with Google Cal'; stat.style.color='var(--accent)';
  } else {
    btn.classList.remove('connected'); lbl.textContent='Connect Google Cal';
    stat.textContent='';
  }
}

async function syncFromGcal() {
  if (!isSignedIn||!gapiReady) return;
  showSyncBar('Fetching Google Calendar...');
  try {
    const now=new Date();
    const min=new Date(now); min.setDate(now.getDate()-1);
    const max=new Date(now); max.setDate(now.getDate()+30);
    const resp=await gapi.client.calendar.events.list({calendarId:'primary',timeMin:min.toISOString(),timeMax:max.toISOString(),singleEvents:true,orderBy:'startTime',maxResults:50});
    gcalEvents=(resp.result.items||[]).map(ev=>{
      const start=ev.start.dateTime||ev.start.date;
      const end=ev.end.dateTime||ev.end.date;
      const sd=new Date(start);
      return {id:ev.id,title:ev.summary||'(No title)',date:sd.toISOString().split('T')[0],hour:sd.getHours()||8,endHour:new Date(end).getHours()||9,allDay:!ev.start.dateTime};
    });
    renderAll(); hideSyncBar();
  } catch(e) {
    hideSyncBar();
    if(e.status===401){isSignedIn=false;localStorage.removeItem('mya_gtoken');updateGcalUI();toast('Session expired ‚Äî reconnect Google Calendar');}
  }
}

async function pushTaskToGcal(task) {
  if (!isSignedIn||!gapiReady){toast('Connect Google Calendar first');return;}
  showSyncBar('Adding to Google Calendar...');
  try {
    const pad=n=>String(n).padStart(2,'0');
    const endH=task.hour+Math.ceil((task.dur||30)/60);
    const tz=Intl.DateTimeFormat().resolvedOptions().timeZone;
    const event={summary:task.title,description:`Category: ${task.cat}${task.notes?'\n'+task.notes:''}`,start:{dateTime:`${task.date}T${pad(task.hour)}:00:00`,timeZone:tz},end:{dateTime:`${task.date}T${pad(Math.min(endH,23))}:00:00`,timeZone:tz}};
    if(task.recur){const m={daily:'DAILY',weekly:'WEEKLY',biweekly:'WEEKLY;INTERVAL=2',monthly:'MONTHLY'};event.recurrence=[`RRULE:FREQ=${m[task.recur]}`];}
    const resp=await gapi.client.calendar.events.insert({calendarId:'primary',resource:event});
    task.gcalId=resp.result.id;
    saveToSheets(); hideSyncBar(); await syncFromGcal();
    toast('‚úì Added to Google Calendar!');
  } catch(e){hideSyncBar();toast('Failed to add to Google Calendar');}
}

function showSyncBar(msg){document.getElementById('syncMsg').textContent=msg;document.getElementById('syncBar').classList.add('visible');}
function hideSyncBar(){document.getElementById('syncBar').classList.remove('visible');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NOTIFICATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkNotifPermission(){if('Notification'in window&&Notification.permission==='default')document.getElementById('notifBanner').classList.add('visible');}
function requestNotif(){Notification.requestPermission().then(p=>{document.getElementById('notifBanner').classList.remove('visible');if(p==='granted'){toast('‚úì Notifications enabled!');scheduleAllReminders();}});}

function scheduleAllReminders(){
  reminderTimers.forEach(clearTimeout); reminderTimers=[];
  const now=new Date();
  reminders.forEach(r=>{
    const t=new Date(r.datetime); const diff=t-now;
    if(diff>0){const tid=setTimeout(()=>{fireNotif('üîî Reminder',r.text);},diff);reminderTimers.push(tid);}
  });
  tasks.forEach(t=>{
    if(t.done) return;
    const taskTime=new Date(`${t.date}T${String(t.hour).padStart(2,'0')}:00:00`);
    const warnTime=new Date(taskTime.getTime()-15*60*1000);
    const diff=warnTime-now;
    if(diff>0&&diff<24*60*60*1000){const tid=setTimeout(()=>{fireNotif('‚è∞ '+t.title,`Starting in 15 minutes at ${HL[t.hour]}`);},diff);reminderTimers.push(tid);}
  });
}

function fireNotif(title,body){
  if('Notification'in window&&Notification.permission==='granted')new Notification(title,{body});
  toast(title+': '+body.substring(0,40));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAll(){renderHeader();renderCalendar();renderSchedule();renderSidebar();renderPanel();updateStats();}

function renderHeader(){
  const d=viewDate;
  document.getElementById('datePill').textContent=`${DAYS[d.getDay()]}, ${MONTHS[d.getMonth()]} ${d.getDate()}, ${d.getFullYear()}`;
  document.getElementById('mainTitle').textContent=DAYS[d.getDay()];
}

function renderCalendar(){
  document.getElementById('calTitle').textContent=`${MONTHS[calDate.getMonth()]} ${calDate.getFullYear()}`;
  const grid=document.getElementById('calGrid');
  grid.innerHTML='';
  ['S','M','T','W','T','F','S'].forEach(d=>{const el=document.createElement('div');el.className='cdn';el.textContent=d;grid.appendChild(el);});
  const first=new Date(calDate.getFullYear(),calDate.getMonth(),1).getDay();
  const dim=new Date(calDate.getFullYear(),calDate.getMonth()+1,0).getDate();
  const td=new Date();
  for(let i=0;i<first;i++){const el=document.createElement('div');el.className='cd';grid.appendChild(el);}
  for(let day=1;day<=dim;day++){
    const el=document.createElement('div');el.className='cd';el.textContent=day;
    const ds=`${calDate.getFullYear()}-${String(calDate.getMonth()+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    const isToday=day===td.getDate()&&calDate.getMonth()===td.getMonth()&&calDate.getFullYear()===td.getFullYear();
    const isSel=ds===todayStr();
    if(isToday)el.classList.add('today');
    else if(isSel)el.classList.add('selected');
    if(tasks.some(t=>t.date===ds)&&!isToday)el.classList.add('has-event');
    el.onclick=()=>{viewDate=new Date(calDate.getFullYear(),calDate.getMonth(),day);renderAll();};
    grid.appendChild(el);
  }
}

function calShift(d){calDate.setMonth(calDate.getMonth()+d);renderCalendar();}

function renderSchedule(){
  const sched=document.getElementById('schedule');
  sched.innerHTML='';
  const dt=dayTasks();
  const gEvs=gcalEvents.filter(e=>e.date===todayStr());

  HOURS.forEach(h=>{
    const slot=document.createElement('div');slot.className='time-slot';
    slot.innerHTML=`<div class="t-label">${HL[h]}</div><div class="t-body" data-hour="${h}"></div>`;
    sched.appendChild(slot);
    const body=slot.querySelector('.t-body');
    dt.filter(t=>t.hour===h).forEach(t=>body.appendChild(makeCard(t)));
    gEvs.filter(e=>e.hour===h).forEach(e=>{if(!dt.some(t=>t.gcalId===e.id))body.appendChild(makeGcalCard(e));});
    const emp=document.createElement('div');emp.className='empty-slot';emp.textContent='+ add here';
    emp.onclick=()=>{openTab('add');setTimeout(()=>{const el=document.getElementById('newHour');if(el)el.value=h;},50);};
    body.appendChild(emp);
    body.addEventListener('dragover',e=>{e.preventDefault();body.classList.add('drag-over');});
    body.addEventListener('dragleave',()=>body.classList.remove('drag-over'));
    body.addEventListener('drop',e=>{e.preventDefault();body.classList.remove('drag-over');if(dragId!==null){const t=tasks.find(t=>t.id===dragId);if(t){t.hour=h;t.date=todayStr();saveToSheets();renderSchedule();renderSidebar();toast(`Moved to ${HL[h]}`);}}});
  });

  // Time indicator
  const now=new Date(); const isToday=todayStr()===realToday();
  if(isToday){
    const cur=now.getHours()+now.getMinutes()/60;
    if(cur>=6&&cur<=23){
      const pct=(cur-6)/(23-6);
      const line=document.createElement('div');line.className='now-line';
      line.style.top=(pct*sched.scrollHeight)+'px';
      line.innerHTML=`<span class="now-label">${now.getHours()%12||12}:${String(now.getMinutes()).padStart(2,'0')} ${now.getHours()>=12?'PM':'AM'}</span>`;
      sched.style.position='relative'; sched.appendChild(line);
    }
  }
  updateStats();
}

function makeCard(t){
  const card=document.createElement('div');
  card.className=`tc c-${t.cat}${t.done?' done':''}`;
  card.draggable=true; card.dataset.id=t.id;
  const rl={daily:'Daily',weekly:'Weekly',biweekly:'Every 2 wks',monthly:'Monthly'};
  const recTag=t.recur?`<span class="tc-recur">‚Üª ${rl[t.recur]}</span>`:'';
  const durTag=t.dur?`<span class="tc-dur">‚è± ${t.dur}m</span>`:'';
  const gcalTag=t.gcalId?`<span class="tc-tag gcal-tag">üìÖ</span>`:'';
  const pushBtn=!t.gcalId?`<button class="tc-btn push-btn" title="Push to Google Calendar" onclick="pushToGcal(${t.id})">üìÖ</button>`:'';
  card.innerHTML=`<div class="tc-grip">‚ãÆ‚ãÆ</div><div class="tc-check ${t.done?'chk':''}" onclick="toggleDone(${t.id})"></div><div class="tc-info"><div class="tc-title">${t.title}</div><div class="tc-meta"><span class="tc-tag">${t.cat}</span>${gcalTag}${recTag}${durTag}</div></div><div class="tc-actions">${pushBtn}<button class="tc-btn" onclick="deleteTask(${t.id})" title="Delete">‚úï</button></div>`;
  card.addEventListener('dragstart',()=>{dragId=t.id;card.classList.add('dragging');});
  card.addEventListener('dragend',()=>{dragId=null;card.classList.remove('dragging');});
  return card;
}

function makeGcalCard(e){
  const card=document.createElement('div');card.className='tc c-gcal';
  card.innerHTML=`<div class="tc-info"><div class="tc-title" style="color:var(--accent3)">üìÖ ${e.title}</div><div class="tc-meta"><span class="tc-tag gcal-tag">Google Calendar</span><span class="tc-dur">${HL[e.hour]}</span></div></div><div class="tc-actions" style="opacity:1"><button class="tc-btn" style="color:var(--accent3);font-size:.63rem;" onclick="importGcalEvent('${e.id}')">Import</button></div>`;
  return card;
}

function renderSidebar(){
  const now=new Date();
  const upcoming=tasks.filter(t=>{const d=new Date(t.date+'T12:00:00');const diff=(d-now)/86400000;return diff>0&&diff<=7&&!t.done;}).sort((a,b)=>a.date.localeCompare(b.date)||a.hour-b.hour).slice(0,5);
  const ul=document.getElementById('upcomingList');
  ul.innerHTML=upcoming.length?'':'<div style="font-size:.73rem;color:var(--muted)">All clear ‚úì</div>';
  upcoming.forEach(t=>{
    const d=new Date(t.date+'T12:00:00');const diff=Math.ceil((d-now)/86400000);
    const lbl=diff===1?'Tomorrow':`In ${diff} days`;
    const div=document.createElement('div');div.className='upc-item';
    div.onclick=()=>{viewDate=new Date(t.date+'T12:00:00');renderAll();};
    div.innerHTML=`<div class="upc-dot" style="background:${CAT_COLORS[t.cat]||CAT_COLORS.work}"></div><div><div class="upc-text">${t.title}</div><div class="upc-date">${lbl} ¬∑ ${HL[t.hour]}</div></div>`;
    ul.appendChild(div);
  });

  const rl=document.getElementById('reminderList');
  rl.innerHTML='';
  const activeRems=reminders.filter(r=>new Date(r.datetime)>new Date()).slice(0,4);
  if(!activeRems.length){rl.innerHTML='<div style="font-size:.73rem;color:var(--muted)">No reminders set</div>';return;}
  activeRems.forEach(r=>{
    const dt=new Date(r.datetime);
    const div=document.createElement('div');div.className='rem-item';
    div.innerHTML=`<span>üîî</span><span class="rem-text">${r.text}</span><span class="rem-time">${dt.toLocaleDateString('en-US',{month:'short',day:'numeric'})} ${dt.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'})}</span><button class="rem-del" onclick="deleteReminder(${r.id})">‚úï</button>`;
    rl.appendChild(div);
  });
}

function updateStats(){
  const day=dayTasks();const done=day.filter(t=>t.done).length;const total=day.length;const pct=total?Math.round(done/total*100):0;
  document.getElementById('sDone').textContent=done;document.getElementById('sLeft').textContent=total-done;document.getElementById('sTotal').textContent=total;
  document.getElementById('progFill').style.width=pct+'%';document.getElementById('mcDone').textContent=done;document.getElementById('mcTotal').textContent=total;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RIGHT PANEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openTab(tab){
  activeTab=tab;
  document.querySelectorAll('.rtab').forEach(t=>t.classList.remove('active'));
  const el=document.getElementById('rtab-'+tab);if(el)el.classList.add('active');
  renderPanel();
}

function renderPanel(){
  const body=document.getElementById('rpanelBody');

  if(activeTab==='chat'){
    body.innerHTML=`
      <div class="chat-wrap">
        <div class="chat-suggestions">
          <button class="chat-sug" onclick="sendSuggestion('What do I have today?')">What do I have today?</button>
          <button class="chat-sug" onclick="sendSuggestion('Add a task for me')">Add a task</button>
          <button class="chat-sug" onclick="sendSuggestion('Set a reminder for tomorrow')">Set reminder</button>
          <button class="chat-sug" onclick="sendSuggestion('How am I doing today?')">How am I doing?</button>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input-wrap">
          <textarea class="chat-input" id="chatInput" placeholder="Ask me anything or say 'add clean bedroom every 2 weeks'..." onkeydown="chatKeydown(event)"></textarea>
          <button class="chat-send" onclick="sendChat()">‚Üë</button>
        </div>
      </div>`;
    renderChatMessages();
  }

  if(activeTab==='overview'){
    const q=QUOTES[Math.floor(Math.random()*QUOTES.length)];
    body.innerHTML=`<div class="mot-card"><div class="mot-label">‚ú¶ Daily Motivation</div><div class="mot-quote">"${q}"</div></div><div class="s-label" style="margin-bottom:10px">All Tasks Today</div><div id="overviewList"></div>`;
    const list=document.getElementById('overviewList');
    const day=dayTasks().sort((a,b)=>a.hour-b.hour);
    if(!day.length)list.innerHTML='<div style="font-size:.78rem;color:var(--muted);padding:8px 0">No tasks today. Ask the AI to add some!</div>';
    else day.forEach(t=>list.appendChild(makeCard(t)));
  }

  if(activeTab==='add'){
    body.innerHTML=`
      <div class="form-group"><label>Task Name</label><input type="text" id="newTitle" placeholder="e.g. Clean bedroom" /></div>
      <div class="form-group"><label>Category</label><div class="pills">
        <button class="pill" data-c="work" onclick="selCatFn('work')">üíº Work</button>
        <button class="pill" data-c="personal" onclick="selCatFn('personal')">‚≠ê Personal</button>
        <button class="pill" data-c="health" onclick="selCatFn('health')">üèÉ Health</button>
        <button class="pill" data-c="home" onclick="selCatFn('home')">üè† Home</button>
      </div></div>
      <div class="form-group"><label>Start Time</label><select id="newHour">${HOURS.map(h=>`<option value="${h}">${HL[h]}</option>`).join('')}</select></div>
      <div class="form-group"><label>Duration (minutes)</label><input type="number" id="newDur" value="30" min="5" max="480" /></div>
      <div class="form-group"><label>Date</label><input type="date" id="newDate" value="${realToday()}" /></div>
      <div class="form-group"><label>Repeats</label><div class="recur-pills">
        <button class="rpill" data-r="none" onclick="selRecurFn(null)">None</button>
        <button class="rpill" data-r="daily" onclick="selRecurFn('daily')">Daily</button>
        <button class="rpill" data-r="weekly" onclick="selRecurFn('weekly')">Weekly</button>
        <button class="rpill" data-r="biweekly" onclick="selRecurFn('biweekly')">Every 2 wks</button>
        <button class="rpill" data-r="monthly" onclick="selRecurFn('monthly')">Monthly</button>
      </div></div>
      <div class="form-group"><label>Notes</label><textarea id="newNotes" placeholder="Optional notes..."></textarea></div>
      <div style="display:flex;gap:7px;margin-top:4px">
        <button class="btn btn-primary" style="flex:1;justify-content:center;padding:10px" onclick="addTask()">Add Task</button>
        ${isSignedIn?`<button class="btn btn-ghost" style="font-size:.7rem" onclick="addTask(true)">+ GCal</button>`:''}
      </div>`;
    selCatFn(selCat); selRecurFn(selRecur);
  }

  if(activeTab==='remind'){
    const activeRems=reminders.filter(r=>new Date(r.datetime)>new Date());
    body.innerHTML=`
      <div class="s-label" style="margin-bottom:8px">Set a Reminder</div>
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:14px;margin-bottom:16px">
        <div class="form-group"><label>Reminder Text</label><input type="text" id="remText" placeholder="e.g. Take medication" /></div>
        <div class="form-group"><label>Date</label><input type="date" id="remDate" value="${realToday()}" /></div>
        <div class="form-group" style="margin-bottom:0"><label>Time</label><input type="time" id="remTime" value="09:00" /></div>
        <button class="btn btn-primary" style="width:100%;justify-content:center;padding:10px;margin-top:12px" onclick="saveReminder()">Set Reminder üîî</button>
      </div>
      <div class="s-label" style="margin-bottom:8px">All Reminders (${activeRems.length})</div>
      ${activeRems.length?activeRems.map(r=>{const dt=new Date(r.datetime);return`<div class="rem-item" style="margin-bottom:5px"><span>üîî</span><span class="rem-text">${r.text}</span><span class="rem-time">${dt.toLocaleDateString('en-US',{month:'short',day:'numeric'})} ${dt.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'})}</span><button class="rem-del" onclick="deleteReminder(${r.id})">‚úï</button></div>`;}).join(''):'<div style="font-size:.78rem;color:var(--muted)">No active reminders</div>'}`;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHAT FUNCTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderChatMessages(){
  const container=document.getElementById('chatMessages');
  if(!container) return;
  container.innerHTML='';
  if(!chatHistory.length){
    const div=document.createElement('div');div.className='chat-msg ai';
    div.innerHTML=`<div class="chat-avatar ai">A</div><div class="chat-bubble">Hi! I'm your personal assistant. I can help you manage your schedule, add tasks, set reminders, and answer questions about your day. Try saying something like <em>"add clean bedroom every 2 weeks at 3pm"</em> or <em>"what do I have today?"</em></div>`;
    container.appendChild(div);
    return;
  }
  chatHistory.forEach(m=>{
    const div=document.createElement('div');div.className=`chat-msg ${m.role==='user'?'user':'ai'}`;
    const text=m.content.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\n/g,'<br>');
    div.innerHTML=m.role==='user'
      ?`<div class="chat-avatar user">U</div><div class="chat-bubble">${text}</div>`
      :`<div class="chat-avatar ai">A</div><div class="chat-bubble">${text}</div>`;
    container.appendChild(div);
  });
  container.scrollTop=container.scrollHeight;
}

function addThinkingBubble(){
  const container=document.getElementById('chatMessages');
  if(!container) return;
  const div=document.createElement('div');div.className='chat-msg ai';div.id='thinking';
  div.innerHTML=`<div class="chat-avatar ai">A</div><div class="chat-bubble thinking">Thinking<span class="spin" style="display:inline-block;margin-left:4px">‚ü≥</span></div>`;
  container.appendChild(div);
  container.scrollTop=container.scrollHeight;
}

function removeThinkingBubble(){const el=document.getElementById('thinking');if(el)el.remove();}

async function sendChat(){
  const input=document.getElementById('chatInput');
  if(!input) return;
  const msg=input.value.trim();
  if(!msg) return;
  input.value='';

  chatHistory.push({role:'user',content:msg});
  renderChatMessages();
  addThinkingBubble();

  try {
    const rawReply=await askGemini(msg);
    const reply=parseAndExecuteAction(rawReply);
    removeThinkingBubble();
    chatHistory.push({role:'model',content:reply});
    renderChatMessages();
  } catch(e) {
    removeThinkingBubble();
    const errMsg="I'm having trouble connecting right now. Please check your internet connection and try again.";
    chatHistory.push({role:'model',content:errMsg});
    renderChatMessages();
  }
}

function chatKeydown(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendChat();}}
function sendSuggestion(msg){const input=document.getElementById('chatInput');if(input){input.value=msg;sendChat();}}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function selCatFn(c){
  selCat=c;
  document.querySelectorAll('.pill').forEach(p=>{p.className='pill';if(p.dataset.c===c)p.classList.add('active-'+c);});
}

function selRecurFn(r){
  selRecur=r;
  document.querySelectorAll('.rpill').forEach(p=>p.classList.toggle('active',(p.dataset.r==='none'&&r===null)||p.dataset.r===r));
}

function addTask(pushGcal=false){
  const title=document.getElementById('newTitle')?.value.trim();
  if(!title){toast('Enter a task name');return;}
  const task={id:nextId(),title,hour:parseInt(document.getElementById('newHour').value),cat:selCat,dur:parseInt(document.getElementById('newDur').value)||30,done:false,recur:selRecur,date:document.getElementById('newDate').value||realToday(),notes:document.getElementById('newNotes')?.value.trim()||'',gcalId:null};
  tasks.push(task);
  if(selRecur){const imap={daily:1,weekly:7,biweekly:14,monthly:30};const days=imap[selRecur];for(let i=1;i<=12;i++){const fd=new Date(task.date);fd.setDate(fd.getDate()+days*i);tasks.push({...task,id:nextId()+i,done:false,gcalId:null,date:fd.toISOString().split('T')[0]});}}
  saveToSheets();renderAll();renderCalendar();scheduleAllReminders();
  toast(`‚úì "${task.title}" added`);
  if(pushGcal&&isSignedIn)pushTaskToGcal(task);
  openTab('chat');
}

function toggleDone(id){
  const t=tasks.find(t=>t.id===id);
  if(t){t.done=!t.done;saveToSheets();renderSchedule();renderSidebar();renderPanel();if(t.done)toast('‚úì Task completed!');}
}

function deleteTask(id){
  const t=tasks.find(t=>t.id===id);
  tasks=tasks.filter(t=>t.id!==id);
  saveToSheets();renderSchedule();renderSidebar();renderPanel();toast('Task removed');
}

function pushToGcal(id){const t=tasks.find(t=>t.id===id);if(t)pushTaskToGcal(t);}

function importGcalEvent(gcalId){
  const e=gcalEvents.find(e=>e.id===gcalId);if(!e)return;
  if(tasks.some(t=>t.gcalId===gcalId)){toast('Already imported');return;}
  tasks.push({id:nextId(),title:e.title,hour:e.hour,cat:'work',dur:(e.endHour-e.hour)*60||60,done:false,recur:null,date:e.date,notes:'From Google Calendar',gcalId});
  saveToSheets();renderAll();toast(`‚úì "${e.title}" imported`);
}

function saveReminder(){
  const text=document.getElementById('remText')?.value.trim();
  const date=document.getElementById('remDate')?.value;
  const time=document.getElementById('remTime')?.value||'09:00';
  if(!text){toast('Enter reminder text');return;}
  reminders.push({id:Date.now(),text,datetime:`${date}T${time}:00`});
  saveToSheets();scheduleAllReminders();renderSidebar();renderPanel();toast('üîî Reminder set!');
}

function deleteReminder(id){
  reminders=reminders.filter(r=>r.id!==id);
  saveToSheets();scheduleAllReminders();renderSidebar();renderPanel();toast('Reminder removed');
}

function shiftDay(dir){viewDate.setDate(viewDate.getDate()+dir);renderAll();}
function goToday(){viewDate=new Date();calDate=new Date();renderAll();}

function toast(msg){
  const el=document.getElementById('toast');el.textContent=msg;el.classList.add('show');
  setTimeout(()=>el.classList.remove('show'),2800);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BOOT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadGoogleScripts() {
  // Load GAPI
  const s1 = document.createElement('script');
  s1.src = 'https://apis.google.com/js/api.js';
  s1.onload = () => {
    // Load GSI after GAPI is ready
    const s2 = document.createElement('script');
    s2.src = 'https://accounts.google.com/gsi/client';
    s2.onload = () => { initGapi(); };
    s2.onerror = () => { console.log('GSI failed to load'); };
    document.head.appendChild(s2);
  };
  s1.onerror = () => { console.log('GAPI failed to load'); };
  document.head.appendChild(s1);
}

document.addEventListener('DOMContentLoaded', () => {
  // Load from localStorage immediately so page shows data right away
  try {
    const cached = localStorage.getItem('mya_tasks');
    if (cached) tasks = JSON.parse(cached);
    const cachedR = localStorage.getItem('mya_reminders');
    if (cachedR) reminders = JSON.parse(cachedR);
  } catch(e) {}
  if (!tasks.length) seedTasks();

  // Render immediately ‚Äî don't wait for any external scripts
  renderAll();
  checkNotifPermission();
  scheduleAllReminders();

  // Load Google APIs in background after page is visible
  setTimeout(loadGoogleScripts, 500);

  // Load fresh data from Sheets in background
  setTimeout(loadFromSheets, 1000);

  // Auto-sync every 5 minutes
  setInterval(loadFromSheets, 5 * 60 * 1000);

  // Time indicator refresh every minute
  setInterval(() => { renderSchedule(); scheduleAllReminders(); }, 60000);
});
</script>
</body>
</html>
