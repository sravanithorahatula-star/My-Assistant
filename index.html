<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Assistant</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0c0c0e;
    --surface: #16161a;
    --surface2: #1e1e24;
    --border: #28282f;
    --accent: #b8ff4f;
    --accent2: #5c7cff;
    --accent3: #ff7c5c;
    --text: #eeede8;
    --muted: #6e6e80;
    --done-color: #2e2e38;
    --red: #ff5c5c;
    --purple: #b07cff;
    --orange: #ffaa5c;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* â•â• HEADER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 28px;
    height: 58px;
    border-bottom: 1px solid var(--border);
    background: var(--bg);
    position: relative;
    z-index: 100;
    flex-shrink: 0;
  }

  .logo {
    font-family: 'DM Serif Display', serif;
    font-size: 1.35rem;
    letter-spacing: -.4px;
  }
  .logo em { color: var(--accent); font-style: normal; }

  .header-center { display: flex; align-items: center; gap: 10px; }

  .date-nav { display: flex; align-items: center; gap: 4px; }
  .date-nav-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    width: 28px; height: 28px;
    border-radius: 6px;
    cursor: pointer;
    font-size: .9rem;
    display: flex; align-items: center; justify-content: center;
    transition: all .15s;
  }
  .date-nav-btn:hover { color: var(--text); border-color: var(--muted); }
  .date-pill {
    font-size: .78rem;
    font-weight: 600;
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 5px 14px;
    border-radius: 20px;
    min-width: 160px;
    text-align: center;
    cursor: pointer;
  }
  .date-pill:hover { border-color: var(--muted); }

  .header-right { display: flex; align-items: center; gap: 8px; }

  /* Google auth button */
  .gcal-btn {
    display: flex;
    align-items: center;
    gap: 7px;
    font-family: 'DM Sans', sans-serif;
    font-size: .78rem;
    font-weight: 600;
    padding: 7px 14px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--muted);
    cursor: pointer;
    transition: all .2s;
  }
  .gcal-btn:hover { border-color: var(--muted); color: var(--text); }
  .gcal-btn.connected { border-color: var(--accent); color: var(--accent); background: rgba(184,255,79,.06); }
  .gcal-btn .dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    background: var(--muted);
    flex-shrink: 0;
  }
  .gcal-btn.connected .dot { background: var(--accent); }

  .btn {
    font-family: 'DM Sans', sans-serif;
    font-size: .78rem;
    font-weight: 600;
    padding: 7px 16px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    transition: all .15s;
    display: flex; align-items: center; gap: 6px;
  }
  .btn-primary { background: var(--accent); color: #0c0c0e; }
  .btn-primary:hover { filter: brightness(1.1); transform: translateY(-1px); }
  .btn-ghost { background: transparent; color: var(--muted); border: 1px solid var(--border); }
  .btn-ghost:hover { color: var(--text); border-color: var(--muted); }

  /* â•â• SYNC STATUS BAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .sync-bar {
    display: none;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 7px;
    background: rgba(92,124,255,.12);
    border-bottom: 1px solid rgba(92,124,255,.2);
    font-size: .75rem;
    color: var(--accent2);
    font-weight: 500;
    flex-shrink: 0;
  }
  .sync-bar.visible { display: flex; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .spin { display: inline-block; animation: spin .8s linear infinite; }

  /* â•â• LAYOUT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .app-body {
    display: grid;
    grid-template-columns: 240px 1fr 290px;
    flex: 1;
    overflow: hidden;
    height: calc(100vh - 58px);
  }

  /* â•â• LEFT SIDEBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .sidebar {
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .sidebar-scroll {
    overflow-y: auto;
    flex: 1;
    padding: 20px 16px;
    display: flex;
    flex-direction: column;
    gap: 24px;
  }

  .s-label {
    font-size: .65rem;
    font-weight: 600;
    letter-spacing: .1em;
    color: var(--muted);
    text-transform: uppercase;
    margin-bottom: 10px;
  }

  /* Mini calendar */
  .cal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
  .cal-header span { font-size: .82rem; font-weight: 600; }
  .cal-arrow {
    background: none; border: none; color: var(--muted);
    cursor: pointer; font-size: 1rem; padding: 2px 5px;
    border-radius: 4px; transition: color .15s;
  }
  .cal-arrow:hover { color: var(--text); }
  .cal-grid { display: grid; grid-template-columns: repeat(7,1fr); gap: 2px; text-align: center; }
  .cdn { font-size: .6rem; color: var(--muted); padding: 3px 0; font-weight: 600; }
  .cd {
    font-size: .72rem; padding: 5px 2px;
    border-radius: 5px; cursor: pointer;
    color: var(--muted); transition: all .15s;
  }
  .cd:hover { background: var(--surface2); color: var(--text); }
  .cd.today { background: var(--accent); color: #0c0c0e; font-weight: 700; }
  .cd.selected { background: var(--surface2); color: var(--text); outline: 1px solid var(--accent2); }
  .cd.has-event { color: var(--text); }
  .cd.has-event::after { content:'Â·'; display:block; color:var(--accent2); margin-top:-6px; font-size:1.2rem; }
  .cd.gcal-event { color: var(--text); }
  .cd.gcal-event::after { content:'Â·'; display:block; color:var(--accent3); margin-top:-6px; font-size:1.2rem; }

  /* Progress */
  .prog-wrap { display: flex; flex-direction: column; gap: 7px; }
  .prog-row { display: flex; justify-content: space-between; font-size: .78rem; }
  .prog-label { color: var(--muted); }
  .prog-val { font-weight: 600; }
  .prog-val.g { color: var(--accent); }
  .prog-val.b { color: var(--accent2); }
  .prog-bar { height: 3px; background: var(--surface2); border-radius: 3px; overflow: hidden; margin-top: 2px; }
  .prog-fill { height: 100%; background: var(--accent); border-radius: 3px; transition: width .6s ease; }

  /* Upcoming */
  .upcoming-list { display: flex; flex-direction: column; gap: 5px; }
  .upc-item {
    display: flex; gap: 8px; align-items: flex-start;
    padding: 8px 10px;
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 8px; font-size: .75rem; cursor: pointer;
    transition: border-color .15s;
  }
  .upc-item:hover { border-color: var(--muted); }
  .upc-dot { width:7px; height:7px; border-radius:50%; flex-shrink:0; margin-top:3px; }
  .upc-text { color: var(--text); line-height: 1.35; }
  .upc-date { color: var(--muted); font-size: .67rem; margin-top: 2px; }
  .upc-gcal { font-size: .6rem; color: var(--accent3); }

  /* Reminder list */
  .reminder-list { display: flex; flex-direction: column; gap: 5px; }
  .rem-item {
    display: flex; align-items: center; gap: 8px;
    padding: 8px 10px;
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 8px; font-size: .75rem;
  }
  .rem-bell { font-size: .9rem; }
  .rem-text { flex: 1; color: var(--text); }
  .rem-time { color: var(--muted); font-size: .67rem; white-space: nowrap; }
  .rem-del { background: none; border: none; color: var(--muted); cursor: pointer; font-size: .7rem; padding: 2px 4px; border-radius: 3px; }
  .rem-del:hover { color: var(--red); }

  /* â•â• MAIN AREA â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .main {
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .main-top {
    padding: 20px 28px 14px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }

  .main-title {
    font-family: 'DM Serif Display', serif;
    font-size: 1.9rem;
    line-height: 1;
  }
  .main-sub { color: var(--muted); font-size: .8rem; margin-top: 5px; display: flex; align-items: center; gap: 12px; }
  .main-sub-count strong { color: var(--accent); }

  .schedule-wrap { flex: 1; overflow-y: auto; padding: 10px 28px 24px; }

  /* Schedule */
  .time-slot { display: grid; grid-template-columns: 52px 1fr; min-height: 60px; }
  .t-label {
    font-size: .68rem; color: var(--muted); padding-top: 8px;
    text-align: right; padding-right: 14px; font-weight: 500;
    flex-shrink: 0; line-height: 1;
  }
  .t-body {
    border-left: 1px solid var(--border);
    padding: 5px 0 5px 14px;
    position: relative;
    min-height: 60px;
    transition: background .15s;
  }
  .t-body::before {
    content: '';
    position: absolute; left: -4px; top: 10px;
    width: 6px; height: 6px;
    border-radius: 50%;
    border: 1px solid var(--border);
    background: var(--bg);
    transition: all .15s;
  }
  .t-body.drag-over {
    background: rgba(92,124,255,.07);
  }
  .t-body.drag-over::before { background: var(--accent2); border-color: var(--accent2); }

  /* Task card */
  .tc {
    display: flex; align-items: flex-start; gap: 9px;
    padding: 9px 12px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 9px;
    margin-bottom: 5px;
    cursor: grab;
    transition: all .15s;
    user-select: none;
    position: relative;
    overflow: hidden;
    animation: slideIn .2s ease;
  }
  @keyframes slideIn {
    from { opacity:0; transform: translateX(-6px); }
    to { opacity:1; transform: translateX(0); }
  }
  .tc::before { content:''; position:absolute; left:0; top:0; bottom:0; width:3px; border-radius:3px 0 0 3px; }
  .tc:hover { border-color: var(--muted); transform: translateX(3px); }
  .tc.dragging { opacity:.3; cursor: grabbing; }
  .tc.done { opacity: .45; }
  .tc.done .tc-title { text-decoration: line-through; color: var(--muted); }
  .tc.gcal { border-style: dashed; }

  .c-work::before { background: var(--accent2); }
  .c-personal::before { background: var(--accent); }
  .c-health::before { background: var(--orange); }
  .c-home::before { background: var(--purple); }
  .c-gcal::before { background: var(--accent3); }

  .tc-grip { color: var(--muted); font-size: .85rem; cursor: grab; margin-top: 2px; opacity: 0; transition: opacity .15s; }
  .tc:hover .tc-grip { opacity: 1; }

  .tc-check {
    width: 17px; height: 17px;
    border-radius: 50%;
    border: 2px solid var(--border);
    flex-shrink: 0; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all .15s;
    margin-top: 1px;
  }
  .tc-check:hover { border-color: var(--accent); }
  .tc-check.chk { background: var(--accent); border-color: var(--accent); }
  .tc-check.chk::after { content: 'âœ“'; font-size: .6rem; color: #0c0c0e; font-weight: 800; }

  .tc-info { flex: 1; min-width: 0; }
  .tc-title { font-size: .83rem; font-weight: 500; line-height: 1.3; }
  .tc-meta { display: flex; gap: 5px; margin-top: 4px; flex-wrap: wrap; align-items: center; }
  .tc-tag {
    font-size: .62rem; padding: 2px 7px;
    border-radius: 20px; background: var(--surface2);
    color: var(--muted); font-weight: 500;
  }
  .tc-tag.gcal-tag { background: rgba(255,124,92,.12); color: var(--accent3); }
  .tc-dur { font-size: .62rem; color: var(--muted); }
  .tc-recur { font-size: .62rem; color: var(--accent2); }

  .tc-actions { display: flex; gap: 2px; opacity: 0; transition: opacity .15s; }
  .tc:hover .tc-actions { opacity: 1; }
  .tc-btn {
    background: none; border: none;
    color: var(--muted); font-size: .7rem;
    cursor: pointer; padding: 3px 5px; border-radius: 4px;
    transition: all .15s;
  }
  .tc-btn:hover { color: var(--red); background: rgba(255,92,92,.1); }
  .tc-btn.sync-btn:hover { color: var(--accent3); background: rgba(255,124,92,.1); }

  /* Empty slot */
  .empty-slot {
    height: 36px; border: 1px dashed var(--border);
    border-radius: 7px; display: flex; align-items: center;
    justify-content: center; color: var(--muted);
    font-size: .7rem; cursor: pointer; transition: all .15s;
    margin-bottom: 4px;
  }
  .empty-slot:hover { border-color: var(--accent2); color: var(--accent2); background: rgba(92,124,255,.04); }

  /* Time indicator */
  .now-line {
    position: absolute; left: 52px; right: 0;
    height: 2px; background: var(--red);
    z-index: 10; pointer-events: none;
  }
  .now-line::before {
    content: ''; position: absolute; left: 14px; top: -4px;
    width: 9px; height: 9px; border-radius: 50%; background: var(--red);
  }
  .now-label {
    position: absolute; right: 8px; top: -9px;
    font-size: .6rem; color: var(--red); font-weight: 700;
    background: var(--bg); padding: 0 3px;
  }

  /* â•â• RIGHT PANEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .rpanel {
    border-left: 1px solid var(--border);
    display: flex; flex-direction: column;
    overflow: hidden;
  }

  .rtabs { display: flex; border-bottom: 1px solid var(--border); flex-shrink: 0; }
  .rtab {
    flex: 1; padding: 12px 8px;
    font-size: .72rem; font-weight: 600;
    text-align: center; cursor: pointer;
    color: var(--muted); border: none;
    background: none; font-family: 'DM Sans', sans-serif;
    border-bottom: 2px solid transparent;
    transition: all .15s;
  }
  .rtab.active { color: var(--text); border-bottom-color: var(--accent); }

  .rpanel-body { flex: 1; overflow-y: auto; padding: 18px 16px; }

  /* Form */
  .form-group { margin-bottom: 13px; }
  .form-group label {
    display: block; font-size: .67rem; font-weight: 600;
    color: var(--muted); text-transform: uppercase;
    letter-spacing: .07em; margin-bottom: 5px;
  }
  input[type=text], input[type=number], input[type=date], input[type=time], select, textarea {
    width: 100%;
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 7px; color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: .8rem; padding: 8px 11px; outline: none;
    transition: border-color .15s;
    -webkit-appearance: none;
  }
  input:focus, select:focus, textarea:focus { border-color: var(--accent2); }
  select option { background: var(--surface2); }
  textarea { resize: none; height: 52px; }

  .pills { display: flex; gap: 5px; flex-wrap: wrap; }
  .pill {
    font-size: .7rem; padding: 5px 10px;
    border-radius: 20px; border: 1px solid var(--border);
    cursor: pointer; transition: all .15s;
    background: transparent; color: var(--muted);
    font-family: 'DM Sans', sans-serif; font-weight: 500;
  }
  .pill.active-work { background: var(--accent2); color: #fff; border-color: var(--accent2); }
  .pill.active-personal { background: var(--accent); color: #0c0c0e; border-color: var(--accent); }
  .pill.active-health { background: var(--orange); color: #0c0c0e; border-color: var(--orange); }
  .pill.active-home { background: var(--purple); color: #fff; border-color: var(--purple); }

  .recur-pills { display: flex; gap: 5px; flex-wrap: wrap; }
  .rpill {
    font-size: .7rem; padding: 5px 10px;
    border-radius: 20px; border: 1px solid var(--border);
    cursor: pointer; background: transparent; color: var(--muted);
    font-family: 'DM Sans', sans-serif; transition: all .15s;
  }
  .rpill.active { background: var(--surface2); color: var(--text); border-color: var(--accent2); }

  /* Add reminder form */
  .rem-form { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 14px; }

  /* Gcal events list */
  .gcal-event-list { display: flex; flex-direction: column; gap: 6px; }
  .gcal-ev {
    padding: 9px 12px; background: var(--surface);
    border: 1px dashed var(--border); border-radius: 8px;
    font-size: .78rem;
  }
  .gcal-ev-title { font-weight: 500; color: var(--text); }
  .gcal-ev-time { color: var(--muted); font-size: .68rem; margin-top: 2px; }
  .gcal-ev-import {
    font-size: .67rem; color: var(--accent3); cursor: pointer;
    margin-top: 4px; display: inline-block;
  }
  .gcal-ev-import:hover { text-decoration: underline; }

  /* Toast */
  .toast {
    position: fixed; bottom: 20px; left: 50%;
    transform: translateX(-50%) translateY(80px);
    background: var(--surface2); border: 1px solid var(--border);
    color: var(--text); padding: 10px 18px;
    border-radius: 9px; font-size: .8rem; font-weight: 500;
    z-index: 9999; transition: transform .3s ease;
    box-shadow: 0 8px 32px rgba(0,0,0,.6);
    white-space: nowrap;
  }
  .toast.show { transform: translateX(-50%) translateY(0); }

  /* Notification permission banner */
  .notif-banner {
    display: none;
    align-items: center; justify-content: space-between;
    padding: 8px 20px;
    background: rgba(255,170,92,.08);
    border-bottom: 1px solid rgba(255,170,92,.2);
    font-size: .75rem; color: var(--orange);
    flex-shrink: 0;
  }
  .notif-banner.visible { display: flex; }
  .notif-banner button {
    font-family: 'DM Sans', sans-serif;
    font-size: .72rem; font-weight: 600;
    padding: 4px 12px; border-radius: 6px;
    background: var(--orange); color: #0c0c0e;
    border: none; cursor: pointer;
  }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 3px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  /* Schedule relative wrapper */
  .sched-rel { position: relative; }

  /* Motivation */
  .mot-card {
    background: linear-gradient(135deg, #141420 0%, #0e1a2e 100%);
    border: 1px solid var(--border); border-radius: 10px;
    padding: 16px; margin-bottom: 16px;
  }
  .mot-label { font-size: .62rem; color: var(--accent2); font-weight: 600; letter-spacing: .08em; text-transform: uppercase; margin-bottom: 7px; }
  .mot-quote { font-family: 'DM Serif Display', serif; font-size: .95rem; line-height: 1.45; color: var(--text); font-style: italic; }
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="logo">my<em>.</em>assistant</div>

  <div class="header-center">
    <div class="date-nav">
      <button class="date-nav-btn" onclick="shiftDay(-1)">â€¹</button>
      <div class="date-pill" id="datePill" onclick="goToday()"></div>
      <button class="date-nav-btn" onclick="shiftDay(1)">â€º</button>
    </div>
  </div>

  <div class="header-right">
    <button class="gcal-btn" id="gcalBtn" onclick="toggleGcal()">
      <span class="dot"></span>
      <span id="gcalBtnLabel">Connect Google Calendar</span>
    </button>
    <button class="btn btn-ghost" onclick="exportICS()">â†‘ .ics</button>
    <button class="btn btn-primary" onclick="openTab('add')">+ Add Task</button>
  </div>
</header>

<!-- NOTIFICATION BANNER -->
<div class="notif-banner" id="notifBanner">
  ğŸ”” Enable desktop notifications to get reminders even when the tab is in the background
  <button onclick="requestNotifPermission()">Enable Notifications</button>
</div>

<!-- SYNC BAR -->
<div class="sync-bar" id="syncBar">
  <span class="spin">âŸ³</span> <span id="syncMsg">Syncing with Google Calendar...</span>
</div>

<div class="app-body">

  <!-- LEFT SIDEBAR -->
  <div class="sidebar">
    <div class="sidebar-scroll">

      <!-- Mini calendar -->
      <div>
        <div class="cal-header">
          <button class="cal-arrow" onclick="calShift(-1)">â€¹</button>
          <span id="calTitle"></span>
          <button class="cal-arrow" onclick="calShift(1)">â€º</button>
        </div>
        <div class="cal-grid" id="calGrid"></div>
      </div>

      <!-- Progress -->
      <div>
        <div class="s-label">Today's Progress</div>
        <div class="prog-wrap">
          <div class="prog-row"><span class="prog-label">Done</span><span class="prog-val g" id="sDone">0</span></div>
          <div class="prog-row"><span class="prog-label">Left</span><span class="prog-val b" id="sLeft">0</span></div>
          <div class="prog-row"><span class="prog-label">Total</span><span class="prog-val" id="sTotal">0</span></div>
          <div class="prog-bar"><div class="prog-fill" id="progFill" style="width:0%"></div></div>
        </div>
      </div>

      <!-- Upcoming -->
      <div>
        <div class="s-label">Next 7 Days</div>
        <div class="upcoming-list" id="upcomingList"></div>
      </div>

      <!-- Active reminders -->
      <div>
        <div class="s-label">Active Reminders</div>
        <div class="reminder-list" id="reminderList"></div>
      </div>

    </div>
  </div>

  <!-- MAIN -->
  <div class="main">
    <div class="main-top">
      <div class="main-title" id="mainTitle"></div>
      <div class="main-sub">
        <span class="main-sub-count"><strong id="mcDone">0</strong> / <span id="mcTotal">0</span> tasks done</span>
        <span id="gcalStatus" style="color:var(--muted);font-size:.75rem;"></span>
      </div>
    </div>
    <div class="schedule-wrap">
      <div class="sched-rel" id="schedRel">
        <div id="schedule"></div>
      </div>
    </div>
  </div>

  <!-- RIGHT PANEL -->
  <div class="rpanel">
    <div class="rtabs">
      <button class="rtab active" id="rtab-overview" onclick="openTab('overview')">Overview</button>
      <button class="rtab" id="rtab-add" onclick="openTab('add')">Add Task</button>
      <button class="rtab" id="rtab-remind" onclick="openTab('remind')">Reminders</button>
      <button class="rtab" id="rtab-gcal" onclick="openTab('gcal')">Google</button>
    </div>
    <div class="rpanel-body" id="rpanelBody"></div>
  </div>

</div>

<div class="toast" id="toast"></div>

<!-- Google API -->
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client"></script>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CLIENT_ID = '432572693539-6r5i8oak1gnhqvimqccfj37hmng7pl43.apps.googleusercontent.com';
const SCOPES = 'https://www.googleapis.com/auth/calendar';
const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';

const HOURS = [6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22];
const HL = {6:'6 AM',7:'7 AM',8:'8 AM',9:'9 AM',10:'10 AM',11:'11 AM',12:'12 PM',13:'1 PM',14:'2 PM',15:'3 PM',16:'4 PM',17:'5 PM',18:'6 PM',19:'7 PM',20:'8 PM',21:'9 PM',22:'10 PM'};
const CAT_COLORS = {work:'var(--accent2)',personal:'var(--accent)',health:'var(--orange)',home:'var(--purple)',gcal:'var(--accent3)'};
const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];
const DAYS = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
const QUOTES = [
  "The secret of getting ahead is getting started.",
  "Small steps every day lead to big results.",
  "Focus on progress, not perfection.",
  "Your future self will thank you.",
  "One day at a time â€” that's enough.",
  "What you do today can improve all your tomorrows."
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let tasks = JSON.parse(localStorage.getItem('mya_tasks') || '[]');
let reminders = JSON.parse(localStorage.getItem('mya_reminders') || '[]');
let gcalEvents = JSON.parse(localStorage.getItem('mya_gcal_events') || '[]');
let viewDate = new Date();
let calDate = new Date();
let dragId = null;
let selCat = 'work';
let selRecur = null;
let activeTab = 'overview';
let gapiReady = false;
let gsiTokenClient = null;
let isSignedIn = false;
let reminderTimers = [];

// Seed sample tasks if empty
if (!tasks.length) {
  const td = new Date();
  const ds = d => { const x = new Date(td); x.setDate(x.getDate()+d); return x.toISOString().split('T')[0]; };
  tasks = [
    {id:1,title:'Morning workout',hour:7,cat:'health',dur:45,done:false,recur:null,date:ds(0),notes:'',gcalId:null},
    {id:2,title:'Review weekly goals',hour:9,cat:'work',dur:30,done:false,recur:null,date:ds(0),notes:'',gcalId:null},
    {id:3,title:'Team standup',hour:10,cat:'work',dur:30,done:false,recur:'daily',date:ds(0),notes:'',gcalId:null},
    {id:4,title:'Lunch break',hour:13,cat:'personal',dur:60,done:false,recur:null,date:ds(0),notes:'',gcalId:null},
    {id:5,title:'Clean bedroom',hour:15,cat:'home',dur:30,done:false,recur:'biweekly',date:ds(0),notes:'Every 2 weeks',gcalId:null},
    {id:6,title:'Deep work session',hour:16,cat:'work',dur:90,done:false,recur:null,date:ds(0),notes:'',gcalId:null},
    {id:7,title:'Evening walk',hour:19,cat:'health',dur:30,done:false,recur:'daily',date:ds(0),notes:'',gcalId:null},
    {id:8,title:'Grocery shopping',hour:11,cat:'home',dur:60,done:false,recur:'weekly',date:ds(3),notes:'',gcalId:null},
  ];
  save();
}

function save() {
  localStorage.setItem('mya_tasks', JSON.stringify(tasks));
  localStorage.setItem('mya_reminders', JSON.stringify(reminders));
  localStorage.setItem('mya_gcal_events', JSON.stringify(gcalEvents));
}

function nextId() { return tasks.length ? Math.max(...tasks.map(t=>t.id))+1 : 1; }
function todayStr() { return viewDate.toISOString().split('T')[0]; }
function dayTasks() { return tasks.filter(t => t.date === todayStr()); }
function realToday() { return new Date().toISOString().split('T')[0]; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GOOGLE API INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initGapi() {
  gapi.load('client', async () => {
    try {
      await gapi.client.init({ discoveryDocs: [DISCOVERY_DOC] });
      gapiReady = true;
      // Restore token if saved
      const savedToken = localStorage.getItem('mya_gtoken');
      if (savedToken) {
        gapi.client.setToken(JSON.parse(savedToken));
        isSignedIn = true;
        updateGcalUI();
        syncFromGcal();
      }
    } catch(e) {
      console.log('GAPI init error:', e);
    }
  });

  gsiTokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: SCOPES,
    callback: (resp) => {
      if (resp.error) { toast('Google auth error: ' + resp.error); return; }
      localStorage.setItem('mya_gtoken', JSON.stringify(gapi.client.getToken()));
      isSignedIn = true;
      updateGcalUI();
      syncFromGcal();
      toast('âœ“ Connected to Google Calendar!');
    }
  });
}

function toggleGcal() {
  if (!gapiReady) { toast('Google API still loading, please wait...'); return; }
  if (isSignedIn) {
    google.accounts.oauth2.revoke(gapi.client.getToken().access_token, () => {
      gapi.client.setToken(null);
      localStorage.removeItem('mya_gtoken');
      isSignedIn = false;
      gcalEvents = [];
      save();
      updateGcalUI();
      renderAll();
      toast('Disconnected from Google Calendar');
    });
  } else {
    gsiTokenClient.requestAccessToken({ prompt: 'consent' });
  }
}

function updateGcalUI() {
  const btn = document.getElementById('gcalBtn');
  const lbl = document.getElementById('gcalBtnLabel');
  if (isSignedIn) {
    btn.classList.add('connected');
    lbl.textContent = 'Google Calendar âœ“';
    document.getElementById('gcalStatus').textContent = 'â— Synced with Google Calendar';
    document.getElementById('gcalStatus').style.color = 'var(--accent)';
  } else {
    btn.classList.remove('connected');
    lbl.textContent = 'Connect Google Calendar';
    document.getElementById('gcalStatus').textContent = '';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GOOGLE CALENDAR SYNC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function syncFromGcal() {
  if (!isSignedIn || !gapiReady) return;
  showSyncBar('Fetching Google Calendar events...');
  try {
    const now = new Date();
    const minTime = new Date(now); minTime.setDate(now.getDate() - 1);
    const maxTime = new Date(now); maxTime.setDate(now.getDate() + 30);

    const resp = await gapi.client.calendar.events.list({
      calendarId: 'primary',
      timeMin: minTime.toISOString(),
      timeMax: maxTime.toISOString(),
      singleEvents: true,
      orderBy: 'startTime',
      maxResults: 50
    });

    gcalEvents = (resp.result.items || []).map(ev => {
      const start = ev.start.dateTime || ev.start.date;
      const end = ev.end.dateTime || ev.end.date;
      const startDate = new Date(start);
      return {
        id: ev.id,
        title: ev.summary || '(No title)',
        date: startDate.toISOString().split('T')[0],
        hour: startDate.getHours() || 8,
        endHour: new Date(end).getHours() || 9,
        allDay: !ev.start.dateTime,
        htmlLink: ev.htmlLink
      };
    });

    save();
    renderAll();
    hideSyncBar();
  } catch(e) {
    hideSyncBar();
    if (e.status === 401) {
      isSignedIn = false;
      localStorage.removeItem('mya_gtoken');
      updateGcalUI();
      toast('Session expired â€” please reconnect Google Calendar');
    } else {
      toast('Could not sync Google Calendar');
    }
  }
}

async function pushTaskToGcal(task) {
  if (!isSignedIn || !gapiReady) { toast('Connect Google Calendar first'); return; }
  showSyncBar('Adding to Google Calendar...');
  try {
    const dateStr = task.date;
    const h = task.hour;
    const endH = h + Math.ceil((task.dur || 30) / 60);
    const pad = n => String(n).padStart(2,'0');

    const event = {
      summary: task.title,
      description: `Category: ${task.cat}${task.notes ? '\n'+task.notes : ''}`,
      start: { dateTime: `${dateStr}T${pad(h)}:00:00`, timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone },
      end: { dateTime: `${dateStr}T${pad(Math.min(endH,23))}:00:00`, timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone },
    };

    if (task.recur) {
      const rrMap = { daily:'DAILY', weekly:'WEEKLY', biweekly:'WEEKLY;INTERVAL=2', monthly:'MONTHLY' };
      event.recurrence = [`RRULE:FREQ=${rrMap[task.recur]}`];
    }

    const resp = await gapi.client.calendar.events.insert({ calendarId: 'primary', resource: event });
    task.gcalId = resp.result.id;
    save();
    hideSyncBar();
    await syncFromGcal();
    toast('âœ“ Added to Google Calendar!');
  } catch(e) {
    hideSyncBar();
    toast('Failed to add to Google Calendar');
  }
}

async function deleteGcalEvent(gcalId) {
  if (!isSignedIn || !gapiReady || !gcalId) return;
  try {
    await gapi.client.calendar.events.delete({ calendarId: 'primary', eventId: gcalId });
    await syncFromGcal();
  } catch(e) { /* ignore */ }
}

function showSyncBar(msg) {
  const bar = document.getElementById('syncBar');
  document.getElementById('syncMsg').textContent = msg;
  bar.classList.add('visible');
}
function hideSyncBar() {
  document.getElementById('syncBar').classList.remove('visible');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NOTIFICATIONS / REMINDERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function checkNotifPermission() {
  if ('Notification' in window && Notification.permission === 'default') {
    document.getElementById('notifBanner').classList.add('visible');
  }
}

function requestNotifPermission() {
  Notification.requestPermission().then(p => {
    document.getElementById('notifBanner').classList.remove('visible');
    if (p === 'granted') {
      toast('âœ“ Notifications enabled!');
      scheduleAllReminders();
    }
  });
}

function scheduleAllReminders() {
  reminderTimers.forEach(clearTimeout);
  reminderTimers = [];

  const now = new Date();
  reminders.forEach(r => {
    const remTime = new Date(r.datetime);
    const diff = remTime - now;
    if (diff > 0) {
      const tid = setTimeout(() => {
        fireReminder(r);
      }, diff);
      reminderTimers.push(tid);
    }
  });

  // Also check task-based reminders (15 min before)
  tasks.forEach(t => {
    if (t.done) return;
    const taskTime = new Date(`${t.date}T${String(t.hour).padStart(2,'0')}:00:00`);
    const warnTime = new Date(taskTime.getTime() - 15*60*1000);
    const diff = warnTime - now;
    if (diff > 0 && diff < 24*60*60*1000) {
      const tid = setTimeout(() => {
        if ('Notification' in window && Notification.permission === 'granted') {
          new Notification('â° ' + t.title, {
            body: `Starting in 15 minutes at ${HL[t.hour]}`,
            icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">ğŸ“…</text></svg>'
          });
        }
      }, Math.max(diff, 0));
      reminderTimers.push(tid);
    }
  });
}

function fireReminder(r) {
  if ('Notification' in window && Notification.permission === 'granted') {
    new Notification('ğŸ”” Reminder', {
      body: r.text,
      icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">ğŸ””</text></svg>'
    });
  }
  toast('ğŸ”” ' + r.text);
}

function addReminder(text, datetime) {
  const rem = { id: Date.now(), text, datetime };
  reminders.push(rem);
  save();
  scheduleAllReminders();
  renderSidebar();
  renderPanel();
  toast('âœ“ Reminder set!');
}

function deleteReminder(id) {
  reminders = reminders.filter(r => r.id !== id);
  save();
  scheduleAllReminders();
  renderSidebar();
  renderPanel();
  toast('Reminder removed');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAll() {
  renderHeader();
  renderCalendar();
  renderSchedule();
  renderSidebar();
  renderPanel();
  updateStats();
}

function renderHeader() {
  const d = viewDate;
  document.getElementById('datePill').textContent =
    `${DAYS[d.getDay()]}, ${MONTHS[d.getMonth()]} ${d.getDate()}, ${d.getFullYear()}`;
  document.getElementById('mainTitle').textContent = DAYS[d.getDay()];
}

// Mini calendar
function renderCalendar() {
  document.getElementById('calTitle').textContent = `${MONTHS[calDate.getMonth()]} ${calDate.getFullYear()}`;
  const grid = document.getElementById('calGrid');
  grid.innerHTML = '';
  ['S','M','T','W','T','F','S'].forEach(d => {
    const el = document.createElement('div');
    el.className = 'cdn'; el.textContent = d;
    grid.appendChild(el);
  });

  const first = new Date(calDate.getFullYear(), calDate.getMonth(), 1).getDay();
  const dim = new Date(calDate.getFullYear(), calDate.getMonth()+1, 0).getDate();
  const td = new Date();

  for (let i=0; i<first; i++) {
    const el = document.createElement('div'); el.className='cd'; grid.appendChild(el);
  }
  for (let day=1; day<=dim; day++) {
    const el = document.createElement('div'); el.className='cd';
    el.textContent = day;
    const ds = `${calDate.getFullYear()}-${String(calDate.getMonth()+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;

    const isToday = day===td.getDate() && calDate.getMonth()===td.getMonth() && calDate.getFullYear()===td.getFullYear();
    const isSelected = ds === todayStr();
    const hasTask = tasks.some(t=>t.date===ds);
    const hasGcal = gcalEvents.some(e=>e.date===ds);

    if (isToday) el.classList.add('today');
    else if (isSelected) el.classList.add('selected');
    if (hasTask && !isToday) el.classList.add('has-event');
    if (hasGcal && !isToday && !hasTask) el.classList.add('gcal-event');

    el.onclick = () => {
      viewDate = new Date(calDate.getFullYear(), calDate.getMonth(), day);
      renderAll();
    };
    grid.appendChild(el);
  }
}

function calShift(dir) { calDate.setMonth(calDate.getMonth()+dir); renderCalendar(); }

// Schedule
function renderSchedule() {
  const sched = document.getElementById('schedule');
  sched.innerHTML = '';
  const dt = dayTasks();
  const gEvs = gcalEvents.filter(e => e.date === todayStr());

  HOURS.forEach(h => {
    const slot = document.createElement('div');
    slot.className = 'time-slot';
    slot.innerHTML = `<div class="t-label">${HL[h]}</div><div class="t-body" data-hour="${h}"></div>`;
    sched.appendChild(slot);

    const body = slot.querySelector('.t-body');

    // Local tasks
    dt.filter(t=>t.hour===h).forEach(t => body.appendChild(makeCard(t)));

    // GCal events
    gEvs.filter(e=>e.hour===h).forEach(e => {
      if (dt.some(t=>t.gcalId===e.id)) return; // already imported
      body.appendChild(makeGcalCard(e));
    });

    // Empty slot
    const emp = document.createElement('div');
    emp.className='empty-slot'; emp.textContent='+ add here';
    emp.onclick=()=>{ document.getElementById('newHour') && (document.getElementById('newHour').value=h); openTab('add'); };
    body.appendChild(emp);

    // Drop
    body.addEventListener('dragover', e=>{e.preventDefault();body.classList.add('drag-over');});
    body.addEventListener('dragleave', ()=>body.classList.remove('drag-over'));
    body.addEventListener('drop', e=>{
      e.preventDefault(); body.classList.remove('drag-over');
      if (dragId!==null) {
        const t=tasks.find(t=>t.id===dragId);
        if(t){t.hour=h;t.date=todayStr();save();renderSchedule();renderSidebar();toast(`Moved to ${HL[h]}`);}
      }
    });
  });

  // Time indicator
  const now = new Date();
  const isToday = todayStr()===realToday();
  if (isToday) {
    const cur = now.getHours()+now.getMinutes()/60;
    if (cur>=6 && cur<=23) {
      const pct = (cur-6)/(23-6);
      const line = document.createElement('div');
      line.className='now-line';
      line.style.top = (pct * sched.offsetHeight) + 'px';
      line.innerHTML = `<span class="now-label">${now.getHours()%12||12}:${String(now.getMinutes()).padStart(2,'0')} ${now.getHours()>=12?'PM':'AM'}</span>`;
      sched.style.position='relative';
      sched.appendChild(line);
    }
  }

  updateStats();
}

function makeCard(t) {
  const card = document.createElement('div');
  card.className = `tc c-${t.cat}${t.done?' done':''}`;
  card.draggable=true; card.dataset.id=t.id;

  const rl = {daily:'Daily',weekly:'Weekly',biweekly:'Every 2 wks',monthly:'Monthly'};
  const recTag = t.recur ? `<span class="tc-recur">â†» ${rl[t.recur]}</span>` : '';
  const durTag = t.dur ? `<span class="tc-dur">â± ${t.dur}m</span>` : '';
  const gcalTag = t.gcalId ? `<span class="tc-tag gcal-tag">ğŸ“… In GCal</span>` : '';
  const syncBtn = !t.gcalId ? `<button class="tc-btn sync-btn" title="Push to Google Calendar" onclick="pushToGcal(${t.id})">ğŸ“…</button>` : '';

  card.innerHTML = `
    <div class="tc-grip">â‹®â‹®</div>
    <div class="tc-check ${t.done?'chk':''}" onclick="toggleDone(${t.id})"></div>
    <div class="tc-info">
      <div class="tc-title">${t.title}</div>
      <div class="tc-meta">
        <span class="tc-tag">${t.cat}</span>
        ${gcalTag}${recTag}${durTag}
      </div>
    </div>
    <div class="tc-actions">
      ${syncBtn}
      <button class="tc-btn" onclick="deleteTask(${t.id})" title="Delete">âœ•</button>
    </div>`;

  card.addEventListener('dragstart', ()=>{dragId=t.id;card.classList.add('dragging');});
  card.addEventListener('dragend', ()=>{dragId=null;card.classList.remove('dragging');});
  return card;
}

function makeGcalCard(e) {
  const card = document.createElement('div');
  card.className = 'tc c-gcal gcal';
  card.innerHTML = `
    <div class="tc-info">
      <div class="tc-title" style="color:var(--accent3)">ğŸ“… ${e.title}</div>
      <div class="tc-meta">
        <span class="tc-tag gcal-tag">Google Calendar</span>
        <span class="tc-dur">${HL[e.hour]}${e.endHour?'â€“'+HL[Math.min(e.endHour,22)]:''}</span>
      </div>
    </div>
    <div class="tc-actions" style="opacity:1">
      <button class="tc-btn" style="color:var(--accent3);font-size:.65rem;" onclick="importGcalEvent('${e.id}')">Import</button>
    </div>`;
  return card;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIDEBAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSidebar() {
  // Upcoming
  const now = new Date();
  const upcoming = tasks.filter(t => {
    const d = new Date(t.date + 'T12:00:00');
    const diff = (d - now) / 86400000;
    return diff > 0 && diff <= 7 && !t.done;
  }).sort((a,b)=>a.date.localeCompare(b.date)||a.hour-b.hour).slice(0,6);

  const ul = document.getElementById('upcomingList');
  ul.innerHTML = upcoming.length ? '' : '<div style="font-size:.75rem;color:var(--muted)">All clear âœ“</div>';
  upcoming.forEach(t => {
    const d = new Date(t.date+'T12:00:00');
    const diff = Math.ceil((d - now)/86400000);
    const lbl = diff===1?'Tomorrow':`In ${diff} days`;
    const div = document.createElement('div');
    div.className='upc-item';
    div.onclick=()=>{viewDate=new Date(t.date+'T12:00:00');renderAll();};
    div.innerHTML=`<div class="upc-dot" style="background:${CAT_COLORS[t.cat]||CAT_COLORS.work}"></div><div><div class="upc-text">${t.title}</div><div class="upc-date">${lbl} Â· ${HL[t.hour]}</div></div>`;
    ul.appendChild(div);
  });

  // Reminders
  const rl = document.getElementById('reminderList');
  rl.innerHTML = '';
  const activeRems = reminders.filter(r => new Date(r.datetime) > new Date()).slice(0,5);
  if (!activeRems.length) {
    rl.innerHTML = '<div style="font-size:.75rem;color:var(--muted)">No reminders set</div>';
  } else {
    activeRems.forEach(r => {
      const dt = new Date(r.datetime);
      const div = document.createElement('div'); div.className='rem-item';
      div.innerHTML=`<span class="rem-bell">ğŸ””</span><span class="rem-text">${r.text}</span><span class="rem-time">${dt.toLocaleDateString('en-US',{month:'short',day:'numeric'})} ${dt.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'})}</span><button class="rem-del" onclick="deleteReminder(${r.id})">âœ•</button>`;
      rl.appendChild(div);
    });
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateStats() {
  const day = dayTasks();
  const done = day.filter(t=>t.done).length;
  const total = day.length;
  const pct = total ? Math.round(done/total*100) : 0;
  document.getElementById('sDone').textContent=done;
  document.getElementById('sLeft').textContent=total-done;
  document.getElementById('sTotal').textContent=total;
  document.getElementById('progFill').style.width=pct+'%';
  document.getElementById('mcDone').textContent=done;
  document.getElementById('mcTotal').textContent=total;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RIGHT PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openTab(tab) {
  activeTab = tab;
  document.querySelectorAll('.rtab').forEach(t=>t.classList.remove('active'));
  const el = document.getElementById('rtab-'+tab);
  if(el) el.classList.add('active');
  renderPanel();
}

function renderPanel() {
  const body = document.getElementById('rpanelBody');

  if (activeTab==='overview') {
    const q = QUOTES[Math.floor(Math.random()*QUOTES.length)];
    body.innerHTML=`
      <div class="mot-card">
        <div class="mot-label">âœ¦ Daily Motivation</div>
        <div class="mot-quote">"${q}"</div>
      </div>
      <div class="s-label" style="margin-bottom:10px">All Tasks Today</div>
      <div id="overviewTaskList"></div>`;
    const list = document.getElementById('overviewTaskList');
    const day = dayTasks().sort((a,b)=>a.hour-b.hour);
    if (!day.length) list.innerHTML='<div style="font-size:.8rem;color:var(--muted);padding:8px 0">No tasks today. Add some!</div>';
    else day.forEach(t=>list.appendChild(makeCard(t)));
  }

  if (activeTab==='add') {
    const td = todayStr();
    body.innerHTML=`
      <div class="form-group">
        <label>Task Name</label>
        <input type="text" id="newTitle" placeholder="e.g. Clean bedroom" />
      </div>
      <div class="form-group">
        <label>Category</label>
        <div class="pills" id="catPills">
          <button class="pill" data-c="work" onclick="selCatFn('work')">ğŸ’¼ Work</button>
          <button class="pill" data-c="personal" onclick="selCatFn('personal')">â­ Personal</button>
          <button class="pill" data-c="health" onclick="selCatFn('health')">ğŸƒ Health</button>
          <button class="pill" data-c="home" onclick="selCatFn('home')">ğŸ  Home</button>
        </div>
      </div>
      <div class="form-group">
        <label>Start Time</label>
        <select id="newHour">${HOURS.map(h=>`<option value="${h}">${HL[h]}</option>`).join('')}</select>
      </div>
      <div class="form-group">
        <label>Duration (minutes)</label>
        <input type="number" id="newDur" value="30" min="5" max="480" />
      </div>
      <div class="form-group">
        <label>Date</label>
        <input type="date" id="newDate" value="${td}" />
      </div>
      <div class="form-group">
        <label>Repeats</label>
        <div class="recur-pills">
          <button class="rpill" data-r="none" onclick="selRecurFn(null)">None</button>
          <button class="rpill" data-r="daily" onclick="selRecurFn('daily')">Daily</button>
          <button class="rpill" data-r="weekly" onclick="selRecurFn('weekly')">Weekly</button>
          <button class="rpill" data-r="biweekly" onclick="selRecurFn('biweekly')">Every 2 wks</button>
          <button class="rpill" data-r="monthly" onclick="selRecurFn('monthly')">Monthly</button>
        </div>
      </div>
      <div class="form-group">
        <label>Notes</label>
        <textarea id="newNotes" placeholder="Optional notes..."></textarea>
      </div>
      <div style="display:flex;gap:8px;margin-top:4px">
        <button class="btn btn-primary" style="flex:1;justify-content:center;padding:10px" onclick="addTask()">Add Task</button>
        ${isSignedIn?`<button class="btn btn-ghost" style="font-size:.72rem" onclick="addTask(true)" title="Add and push to Google Calendar">+ GCal</button>`:''}
      </div>`;
    selCatFn(selCat);
    selRecurFn(selRecur);
  }

  if (activeTab==='remind') {
    const activeRems = reminders.filter(r=>new Date(r.datetime)>new Date());
    body.innerHTML=`
      <div class="s-label" style="margin-bottom:10px">Set a Reminder</div>
      <div class="rem-form">
        <div class="form-group">
          <label>Reminder Text</label>
          <input type="text" id="remText" placeholder="e.g. Take medication" />
        </div>
        <div class="form-group">
          <label>Date</label>
          <input type="date" id="remDate" value="${realToday()}" />
        </div>
        <div class="form-group" style="margin-bottom:0">
          <label>Time</label>
          <input type="time" id="remTime" value="09:00" />
        </div>
        <button class="btn btn-primary" style="width:100%;justify-content:center;padding:10px;margin-top:12px" onclick="saveReminder()">Set Reminder ğŸ””</button>
      </div>
      <div class="s-label" style="margin:18px 0 10px">All Reminders (${activeRems.length})</div>
      <div class="reminder-list">
        ${activeRems.length ? activeRems.map(r=>{
          const dt=new Date(r.datetime);
          return `<div class="rem-item">
            <span class="rem-bell">ğŸ””</span>
            <span class="rem-text">${r.text}</span>
            <span class="rem-time">${dt.toLocaleDateString('en-US',{month:'short',day:'numeric'})} ${dt.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'})}</span>
            <button class="rem-del" onclick="deleteReminder(${r.id})">âœ•</button>
          </div>`;
        }).join('') : '<div style="font-size:.78rem;color:var(--muted)">No active reminders</div>'}
      </div>`;
  }

  if (activeTab==='gcal') {
    const todayGcal = gcalEvents.filter(e=>e.date===todayStr());
    body.innerHTML=`
      <div style="margin-bottom:16px">
        <div class="s-label" style="margin-bottom:8px">Google Calendar Status</div>
        <div style="font-size:.8rem;color:${isSignedIn?'var(--accent)':'var(--muted)'}">
          ${isSignedIn ? 'â— Connected â€” events are syncing' : 'â—‹ Not connected'}
        </div>
        ${!isSignedIn ? `<button class="btn btn-primary" style="margin-top:10px" onclick="toggleGcal()">Connect Google Calendar</button>` : `<button class="btn btn-ghost" style="margin-top:10px;font-size:.75rem" onclick="syncFromGcal()">âŸ³ Refresh Now</button>`}
      </div>
      <div class="s-label" style="margin-bottom:10px">Today's Google Calendar Events</div>
      <div class="gcal-event-list">
        ${todayGcal.length ? todayGcal.map(e=>`
          <div class="gcal-ev">
            <div class="gcal-ev-title">${e.title}</div>
            <div class="gcal-ev-time">${HL[e.hour]}${e.endHour?'â€“'+HL[Math.min(e.endHour,22)]:''} ${e.allDay?'(All day)':''}</div>
            <span class="gcal-ev-import" onclick="importGcalEvent('${e.id}')">+ Import to My Assistant</span>
          </div>`).join('') : `<div style="font-size:.78rem;color:var(--muted)">${isSignedIn?'No Google Calendar events today':'Connect to see your events'}</div>`}
      </div>`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selCatFn(c) {
  selCat=c;
  document.querySelectorAll('.pill').forEach(p=>{
    p.className='pill';
    if(p.dataset.c===c) p.classList.add('active-'+c);
  });
}

function selRecurFn(r) {
  selRecur=r;
  document.querySelectorAll('.rpill').forEach(p=>{
    p.classList.toggle('active', (p.dataset.r==='none'&&r===null)||p.dataset.r===r);
  });
}

function addTask(pushGcal=false) {
  const title = document.getElementById('newTitle')?.value.trim();
  if (!title) { toast('Enter a task name'); return; }
  const hour = parseInt(document.getElementById('newHour').value);
  const dur = parseInt(document.getElementById('newDur').value)||30;
  const date = document.getElementById('newDate').value||todayStr();
  const notes = document.getElementById('newNotes')?.value.trim()||'';

  const task = {id:nextId(),title,hour,cat:selCat,dur,done:false,recur:selRecur,date,notes,gcalId:null};
  tasks.push(task);

  if (selRecur) {
    const imap = {daily:1,weekly:7,biweekly:14,monthly:30};
    const days = imap[selRecur];
    for (let i=1;i<=12;i++) {
      const fd=new Date(date); fd.setDate(fd.getDate()+days*i);
      tasks.push({...task,id:nextId()+i,done:false,gcalId:null,date:fd.toISOString().split('T')[0]});
    }
  }

  save();
  renderAll();
  renderCalendar();
  scheduleAllReminders();
  toast(`âœ“ "${title}" added`);

  if (pushGcal && isSignedIn) {
    pushTaskToGcal(task);
  }

  openTab('overview');
}

function toggleDone(id) {
  const t=tasks.find(t=>t.id===id);
  if(t){t.done=!t.done;save();renderSchedule();renderSidebar();renderPanel();if(t.done)toast('âœ“ Task completed!');}
}

function deleteTask(id) {
  const t=tasks.find(t=>t.id===id);
  if(t&&t.gcalId&&isSignedIn) deleteGcalEvent(t.gcalId);
  tasks=tasks.filter(t=>t.id!==id);
  save();renderSchedule();renderSidebar();renderPanel();toast('Task removed');
}

function pushToGcal(id) {
  const t=tasks.find(t=>t.id===id);
  if(t) pushTaskToGcal(t);
}

function importGcalEvent(gcalId) {
  const e=gcalEvents.find(e=>e.id===gcalId);
  if(!e) return;
  if(tasks.some(t=>t.gcalId===gcalId)){toast('Already imported');return;}
  const task={id:nextId(),title:e.title,hour:e.hour,cat:'work',dur:(e.endHour-e.hour)*60||60,done:false,recur:null,date:e.date,notes:'From Google Calendar',gcalId:gcalId};
  tasks.push(task);
  save();renderAll();toast(`âœ“ "${e.title}" imported`);
}

function saveReminder() {
  const text=document.getElementById('remText')?.value.trim();
  const date=document.getElementById('remDate')?.value;
  const time=document.getElementById('remTime')?.value||'09:00';
  if(!text){toast('Enter reminder text');return;}
  if(!date){toast('Pick a date');return;}
  addReminder(text, `${date}T${time}:00`);
}

function shiftDay(dir) {
  viewDate.setDate(viewDate.getDate()+dir);
  renderAll();
}

function goToday() {
  viewDate=new Date();
  calDate=new Date();
  renderAll();
}

function exportICS() {
  const dt=dayTasks();
  if(!dt.length){toast('No tasks today to export');return;}
  let ics='BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//MyAssistant//EN\n';
  dt.forEach(t=>{
    const d=todayStr().replace(/-/g,'');
    const h=String(t.hour).padStart(2,'0');
    const eh=String(Math.min(t.hour+Math.ceil(t.dur/60),23)).padStart(2,'0');
    ics+=`BEGIN:VEVENT\nSUMMARY:${t.title}\nDTSTART:${d}T${h}0000\nDTEND:${d}T${eh}0000\nCATEGORIES:${t.cat}\nEND:VEVENT\n`;
  });
  ics+='END:VCALENDAR';
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([ics],{type:'text/calendar'}));
  a.download='schedule.ics'; a.click();
  toast('âœ“ Calendar exported!');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.onload = () => {
  renderAll();
  checkNotifPermission();
  scheduleAllReminders();
  setInterval(()=>{
    // refresh time indicator every min
    const old=document.querySelector('.now-line');
    if(old){old.remove();}
    renderSchedule();
    // check reminders
    scheduleAllReminders();
  }, 60000);

  // Init Google APIs
  if(typeof gapi!=='undefined') initGapi();
  else window.addEventListener('load', initGapi);
};
</script>
</body>
</html>
